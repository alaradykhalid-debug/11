<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة كلية طب الأسنان التعليمية - المجمع الأكاديمي اليمني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base styles from the original file */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
        
        :root {
            --dental-blue: #1a73e8;
            --dental-green: #34a853;
            --dental-teal: #00897b;
            --dental-purple: #8e24aa;
            --dental-amber: #ffb300;
            --dental-gray: #546e7a;
            --dental-red: #ea4335; /* Added for algorithms for consistency */
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
            min-height: 100vh;
        }
        
        .dental-gradient {
            background: linear-gradient(135deg, var(--dental-blue) 0%, var(--dental-teal) 100%);
        }
        
        .anatomy-gradient {
            background: linear-gradient(135deg, #5c6bc0 0%, #283593 100%);
        }
        
        .endo-gradient {
            background: linear-gradient(135deg, #26c6da 0%, #006064 100%);
        }
        
        .pros-gradient {
            background: linear-gradient(135deg, #ffb300 0%, #f57c00 100%);
        }
        
        .perio-gradient {
            background: linear-gradient(135deg, #66bb6a 0%, #388e3c 100%);
        }
        
        .oral-gradient {
            background: linear-gradient(135deg, #ab47bc 0%, #6a1b9a 100%);
        }
        
        /* New gradient for Algorithms tab, using existing dental-red or similar vibrant tone */
        .algo-gradient {
            background: linear-gradient(135deg, var(--dental-red) 0%, #c53030 100%);
        }

        .tool-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            background: white;
        }
        
        .tool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(26, 115, 232, 0.15);
        }
        
        .tool-card.active {
            border-color: var(--dental-blue);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .tab-content {
            display: none;
            animation: dentalFadeIn 0.5s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes dentalFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dental-blue) 0%, var(--dental-teal) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .floating-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }
        
        /* شريط التمرير */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #e3f2fd;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--dental-blue) 0%, var(--dental-teal) 100%);
            border-radius: 10px;
        }
        
        /* تصميم البطاقات */
        .dental-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .dental-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }
        
        /* الألوان حسب التخصص */
        .card-anatomy { border-top: 4px solid #5c6bc0; }
        .card-endo { border-top: 4px solid #26c6da; }
        .card-pros { border-top: 4px solid #ffb300; }
        .card-perio { border-top: 4px solid #66bb6a; }
        .card-oral { border-top: 4px solid #ab47bc; }
        .card-pedo { border-top: 4px solid #ec407a; }
        .card-algo { border-top: 4px solid var(--dental-red); } /* New style for algorithms card */
        
        /* تأثيرات النص */
        .dental-title {
            position: relative;
            padding-bottom: 10px;
        }
        
        .dental-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 3px;
            background: var(--dental-blue);
            border-radius: 2px;
        }
        
        /* تصميم الجداول */
        .dental-table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .dental-table th {
            background: linear-gradient(135deg, var(--dental-blue) 0%, var(--dental-teal) 100%);
            color: white;
            font-weight: 600;
            padding: 16px;
        }
        
        .dental-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        /* تصميم أزرار خاصة */
        .btn-dental {
            background: linear-gradient(135deg, var(--dental-blue) 0%, var(--dental-teal) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-dental:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.3);
        }
        
        /* تصميم الإشعارات */
        .dental-alert {
            border-right: 5px solid;
            border-radius: 10px;
            padding: 16px;
            margin: 10px 0;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-info { background: #e3f2fd; border-color: #1a73e8; }
        .alert-warning { background: #fff3e0; border-color: #f57c00; }
        .alert-danger { background: #ffebee; border-color: #e53935; }
        .alert-success { background: #e8f5e9; border-color: #43a047; }
        
        /* تصميم المحاكاة */
        .simulation-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 25px;
            min-height: 300px;
        }
        
        /* تصميم البطاقات التعليمية */
        .flash-card {
            perspective: 1000px;
            width: 300px;
            height: 200px;
            margin: 20px auto;
        }
        
        .flash-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        
        .flash-card.flipped .flash-card-inner {
            transform: rotateY(180deg);
        }
        
        .flash-card-front, .flash-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .flash-card-front {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
        }
        
        .flash-card-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
        }
        
        /* تصميم التقييم الذاتي */
        .quiz-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .quiz-option {
            background: #f5f7fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quiz-option:hover {
            background: #e3f2fd;
            border-color: #1a73e8;
        }
        
        .quiz-option.selected {
            background: #e3f2fd;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .tool-card {
                padding: 1.2rem !important;
                margin-bottom: 1rem;
            }
            
            .dental-table {
                display: block;
                overflow-x: auto;
            }
            
            .flash-card {
                width: 100%;
                height: 180px;
            }
            
            .floating-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                left: 20px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50">
    <div class="min-h-screen">
        
        <!-- الشريط العلوي -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <!-- الشعار والاسم -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full dental-gradient flex items-center justify-center pulse-animation">
                                <i class="fas fa-tooth text-white text-xl"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-800">أداة كلية طب الأسنان التعليمية</h1>
                                <p class="text-xs text-gray-500">المجمع الأكاديمي اليمني - كلية طب الأسنان</p>
                            </div>
                        </div>
                        
                        <!-- شارة الكلية -->
                        <div class="bg-gradient-to-r from-blue-600 to-teal-600 text-white px-5 py-2 rounded-full shadow-md">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-tooth"></i>
                                <span class="font-bold text-sm">كلية طب الأسنان</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- قائمة التنقل -->
                    <div class="hidden md:flex space-x-6">
                        <a href="#" class="nav-item active text-blue-600 font-medium">الرئيسية</a>
                        <a href="#" class="nav-item text-gray-600 hover:text-blue-600 font-medium">تشريح الأسنان</a>
                        <a href="#" class="nav-item text-gray-600 hover:text-blue-600 font-medium">علاج الجذور</a>
                        <a href="#" class="nav-item text-gray-600 hover:text-blue-600 font-medium">البدائل السنية</a>
                        <a href="#" class="nav-item text-gray-600 hover:text-blue-600 font-medium">جراحة الفم</a>
                    </div>
                    
                    <!-- زر القائمة للموبايل -->
                    <button class="md:hidden text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- الهيدر الرئيسي -->
        <header id="dental-header" class="py-10 bg-gradient-to-r from-blue-50 to-teal-100 border-b border-blue-200">
            <div class="container mx-auto px-4">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-tooth text-teal-500 mr-3"></i>
                        منصة التعليم السني المتقدم
                    </h2>
                    <p class="text-gray-600 max-w-3xl mx-auto text-lg">
                        أول منصة تعليمية تفاعلية متخصصة في طب الأسنان تحت رعاية <span class="font-bold text-blue-700">كلية طب الأسنان</span>.
                        تجمع بين المعرفة النظرية والمهارات العملية مع أدوات محاكاة متقدمة.
                    </p>
                    <div class="mt-8">
                        <div class="flex flex-wrap justify-center gap-4">
                            <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm">
                                <i class="fas fa-tooth mr-1"></i> تشريح تفاعلي
                            </span>
                            <span class="px-4 py-2 bg-teal-100 text-teal-700 rounded-full text-sm">
                                <i class="fas fa-tools mr-1"></i> محاكاة العيادة
                            </span>
                            <span class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm">
                                <i class="fas fa-vial mr-1"></i> مواد طب الأسنان
                            </span>
                            <span class="px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm">
                                <i class="fas fa-x-ray mr-1"></i> أشعة الفم
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- المحتوى الرئيسي -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- بطاقات الأدوات الرئيسية -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                
                <!-- بطاقة 1: تشريح الأسنان والفكين -->
                <div class="tool-card active bg-white rounded-2xl p-6 shadow-xl" data-tool="anatomy">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl anatomy-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-tooth text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">تشريح الأسنان والفكين</h3>
                            <p class="text-sm text-gray-600">مستكشف ثلاثي الأبعاد للتشريح السني</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 font-medium">
                            32 سن
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('anatomy')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- بطاقة 2: علاج الجذور -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="endodontics">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl endo-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-tools text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">علاج الجذور</h3>
                            <p class="text-sm text-gray-600">محاكاة إجراءات قناة الجذر</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-teal-100 text-teal-700 font-medium">
                            5 خطوات
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('endodontics')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- بطاقة 3: البدائل السنية -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="prosthodontics">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl pros-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-crown text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">البدائل السنية</h3>
                            <p class="text-sm text-gray-600">تصميم وتخطيط التعويضات السنية</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-700 font-medium">
                            4 أنواع
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('prosthodontics')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- بطاقة 4: أمراض اللثة -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="periodontics">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl perio-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-heartbeat text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">أمراض اللثة</h3>
                            <p class="text-sm text-gray-600">تشخيص وعلاج أمراض دواعم السن</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 font-medium">
                            6 مراحل
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('periodontics')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- بطاقة 5: جراحة الفم -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="oral-surgery">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl oral-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-syringe text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">جراحة الفم والفكين</h3>
                            <p class="text-sm text-gray-600">محاكاة الإجراءات الجراحية السنية</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-purple-100 text-purple-700 font-medium">
                            10 إجراءات
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('oral-surgery')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- بطاقة 6: أشعة الفم -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="radiology">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-gray-600 to-gray-800 flex items-center justify-center mr-3">
                            <i class="fas fa-x-ray text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">أشعة الفم والأسنان</h3>
                            <p class="text-sm text-gray-600">قراءة وتفسير الصور الشعاعية</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-medium">
                            8 أنواع
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('radiology')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>

                <!-- START_UPDATE_NEW_ALGORITHMS_CARD -->
                <!-- بطاقة 7: الخوارزميات والحسابات الطبية -->
                <div class="tool-card bg-white rounded-2xl p-6 shadow-xl" data-tool="algorithms">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 rounded-xl algo-gradient flex items-center justify-center mr-3">
                            <i class="fas fa-calculator text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">الخوارزميات والحسابات</h3>
                            <p class="text-sm text-gray-600">أدوات مساعدة لاتخاذ القرار السريري</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-3 py-1 rounded-full bg-red-100 text-red-700 font-medium">
                            3 أدوات
                        </span>
                        <button class="text-blue-600 hover:text-blue-700 font-medium" onclick="openDentalTool('algorithms')">
                            افتح الأداة <i class="fas fa-arrow-left mr-1"></i>
                        </button>
                    </div>
                </div>
                <!-- END_UPDATE_NEW_ALGORITHMS_CARD -->

            </div>
            
            <!-- منطقة عرض الأداة المحددة -->
            <div class="dental-section bg-white rounded-2xl shadow-xl p-6 mb-8">
                
                <!-- شريط اختيار الأداة -->
                <div class="flex flex-wrap gap-2 mb-8">
                    <button class="px-4 py-2 rounded-full bg-blue-600 text-white font-medium text-sm tab-button active" data-tab="anatomy">
                        <i class="fas fa-tooth mr-1"></i> تشريح الأسنان
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="endodontics">
                        <i class="fas fa-tools mr-1"></i> علاج الجذور
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="prosthodontics">
                        <i class="fas fa-crown mr-1"></i> البدائل السنية
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="periodontics">
                        <i class="fas fa-heartbeat mr-1"></i> أمراض اللثة
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="oral-surgery">
                        <i class="fas fa-syringe mr-1"></i> جراحة الفم
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="radiology">
                        <i class="fas fa-x-ray mr-1"></i> أشعة الفم
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="pedodontics">
                        <i class="fas fa-child mr-1"></i> طب أسنان الأطفال
                    </button>
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="quizzes">
                        <i class="fas fa-question-circle mr-1"></i> الاختبارات
                    </button>
                    <!-- START_UPDATE_NEW_ALGORITHMS_TAB_BUTTON -->
                    <button class="px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium text-sm tab-button" data-tab="algorithms">
                        <i class="fas fa-calculator mr-1"></i> الخوارزميات
                    </button>
                    <!-- END_UPDATE_NEW_ALGORITHMS_TAB_BUTTON -->
                </div>
                
                <!-- محتوى الأداة: تشريح الأسنان - سيتم استبداله بالمحاكي الجديد -->
                <div class="tab-content active" id="anatomy-content">
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-5xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">جارٍ تحميل محاكاة التشريح السني...</h3>
                        <p class="text-gray-600">يرجى الانتظار، قد يستغرق الأمر بضع لحظات</p>
                    </div>
                </div>
                
                <!-- محتوى الأداة: علاج الجذور -->
                <div class="tab-content" id="endodontics-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-tools text-4xl mb-4 text-teal-500"></i>
                        <p class="text-lg">جاري تحميل أداة علاج الجذور...</p>
                        <p class="text-sm mt-2">محاكاة إجراءات قناة الجذر قيد التحميل</p>
                    </div>
                </div>
                
                <!-- محتوى الأداة: البدائل السنية -->
                <div class="tab-content" id="prosthodontics-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-crown text-4xl mb-4 text-amber-500"></i>
                        <p class="text-lg">جاري تحميل أداة البدائل السنية...</p>
                        <p class="text-sm mt-2">تصميم وتخطيط التعويضات السنية</p>
                    </div>
                </div>
                
                <!-- محتوى الأداة: أمراض اللثة -->
                <div class="tab-content" id="periodontics-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-heartbeat text-4xl mb-4 text-green-500"></i>
                        <p class="text-lg">جاري تحميل أداة أمراض اللثة...</p>
                        <p class="text-sm mt-2">تشخيص وعلاج أمراض دواعم السن</p>
                    </div>
                </div>
                
                <!-- محتوى الأداة: جراحة الفم -->
                <div class="tab-content" id="oral-surgery-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-syringe text-4xl mb-4 text-purple-500"></i>
                        <p class="text-lg">جاري تحميل أداة جراحة الفم...</p>
                        <p class="text-sm mt-2">محاكاة الإجراءات الجراحية السنية</p>
                    </div>
                </div>

                <!-- محتوى الأداة: أشعة الفم -->
                <div class="tab-content" id="radiology-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-x-ray text-4xl mb-4 text-gray-500"></i>
                        <p class="text-lg">جاري تحميل أداة أشعة الفم...</p>
                        <p class="text-sm mt-2">قراءة وتفسير الصور الشعاعية</p>
                    </div>
                </div>

                <!-- محتوى الأداة: طب أسنان الأطفال -->
                <div class="tab-content" id="pedodontics-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-child text-4xl mb-4 text-pink-500"></i>
                        <p class="text-lg">جاري تحميل أداة طب أسنان الأطفال...</p>
                        <p class="text-sm mt-2">رعاية الأسنان للأطفال والمراهقين</p>
                    </div>
                </div>

                <!-- محتوى الأداة: الاختبارات التفاعلية -->
                <div class="tab-content" id="quizzes-content">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-question-circle text-4xl mb-4 text-blue-500"></i>
                        <p class="text-lg">جاري تحميل الاختبارات التفاعلية...</p>
                        <p class="text-sm mt-2">اختبارات تقييمية في جميع التخصصات السنية</p>
                    </div>
                </div>

                <!-- START_UPDATE_NEW_ALGORITHMS_TAB_CONTENT -->
                <!-- محتوى الأداة: الخوارزميات والحسابات الطبية -->
                <div class="tab-content" id="algorithms-content">
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-5xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">جارٍ تحميل أدوات الحساب والخوارزميات...</h3>
                        <p class="text-gray-600">يرجى الانتظار، قد يستغرق الأمر بضع لحظات</p>
                    </div>
                </div>
                <!-- END_UPDATE_NEW_ALGORITHMS_TAB_CONTENT -->

            </div>
            
            <!-- قسم المكتبة السنية -->
            <div id="dental-library" class="bg-white rounded-2xl shadow-lg p-6 mt-12">
                <h3 class="font-bold text-xl text-gray-800 mb-4">
                    <i class="fas fa-book text-blue-600 mr-2"></i>
                    المكتبة السنية الرقمية
                </h3>
                <p class="text-gray-600">
                    مصادر علمية موثوقة، أبحاث حديثة، ومراجع تعليمية معتمدة في طب الأسنان.
                </p>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full dental-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-pdf text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">المحاضرات</h4>
                        <p class="text-sm text-gray-600">محاضرات مسجلة وملخصات</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full anatomy-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-video text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">فيديوهات تعليمية</h4>
                        <p class="text-sm text-gray-600">إجراءات عملية مسجلة</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full perio-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-images text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-2">أطلس صور</h4>
                        <p class="text-sm text-gray-600">صور حالات سريرية</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full pros-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-journal-whills text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-2">المجلات</h4>
                        <p class="text-sm text-gray-600">أحدث الأبحاث المنشورة</p>
                    </div>
                </div>
            </div>
            
            <!-- قسم المعلومات الإضافية -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mt-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full dental-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">برعاية كلية طب الأسنان</h4>
                        <p class="text-sm text-gray-600">تطوير التعليم السني في اليمن وفق المعايير العالمية</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full anatomy-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-hands-helping text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-gray-800 mb-2">تعليم تفاعلي</h4>
                        <p class="text-sm text-gray-600">8 أدوات رئيسية تغطي التخصصات السنية</p>
                    </div>
                    
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full endo-gradient flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-tools text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-2">مهارات عملية</h4>
                        <p class="text-sm text-gray-600">محاكاة وتدريب على المهارات السريرية</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- الفوتر -->
        <footer class="bg-gray-900 text-white py-8 mt-12">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="font-bold text-xl mb-4 flex items-center">
                            <i class="fas fa-tooth mr-2"></i>
                            أداة كلية طب الأسنان التعليمية
                        </h3>
                        <p class="text-gray-300 text-sm">
                            منصة تعليمية تفاعلية متكاملة، تقدم أدوات محاكاة وتعليمية متقدمة
                            لتطوير التعليم السني في اليمن والوطن العربي.
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-bold mb-4">برعاية</h4>
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 rounded-full dental-gradient flex items-center justify-center">
                                <i class="fas fa-university"></i>
                            </div>
                            <div>
                                <h5 class="font-bold">كلية طب الأسنان</h5>
                                <p class="text-sm text-gray-300">المجمع الأكاديمي اليمني</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold mb-4">روابط سريعة</h4>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-300 hover:text-white text-sm">تشريح الأسنان</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white text-sm">علاج الجذور</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white text-sm">البدائل السنية</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white text-sm">جراحة الفم</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="border-t border-gray-800 mt-8 pt-8 text-center">
                    <p class="text-gray-400 text-sm">
                        © 2026 أداة كلية طب الأسنان التعليمية - المجمع الأكاديمي اليمني. جميع الحقوق محفوظة.
                    </p>
                    <p class="text-gray-400 text-xs mt-2">
                        تم التطوير وفق المعايير العالمية للتعليم السني
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <!-- الزر العائم -->
    <div class="floating-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
    // متغيرات عامة للمنصة السنية
    const dentalData = {
        anatomy: {
            teeth: [
                { id: 1, name: "القاطع المركزي", type: "قاطع", quadrant: "علوي يمين", function: "قطع الطعام" },
                { id: 2, name: "القاطع الجانبي", type: "قاطع", quadrant: "علوي يمين", function: "قطع الطعام" },
                { id: 3, name: "الناب", type: "ناب", quadrant: "علوي يمين", function: "تمزيق الطعام" },
                { id: 4, name: "الضاحك الأول", type: "ضاحك", quadrant: "علوي يمين", function: "طحن الطعام" },
                { id: 5, name: "الضاحك الثاني", type: "ضاحك", quadrant: "علوي يمين", function: "طحن الطعام" },
                { id: 6, name: "الطاحن الأول", type: "طاحن", quadrant: "علوي يمين", function: "طحن الطعام" },
                { id: 7, name: "الطاحن الثاني", type: "طاحن", quadrant: "علوي يمين", function: "طحن الطعام" },
                { id: 8, name: "الطاحن الثالث", type: "طاحن", quadrant: "علوي يمين", function: "طحن الطعام" }
            ],
            surfaces: ["ماضغة", "وجنية", "لسانية", "مقاربة", "ديستالية"],
            tissues: ["مينا", "عاج", "لب", "ملاط", "رباط دواعم السن"]
        },
        materials: [],
        procedures: []
    };

    /* Imported from تحديث كلية طب الأسنان 1.txt */
    // START_UPDATE_DENTAL_ANATOMY_3D
    /**
     * @overview Dental Anatomy Simulator - Comprehensive module for interactive dental anatomy learning.
     * @module dentalAnatomySimulator
     * @description This module provides a rich set of functionalities for students to learn dental anatomy,
     * including detailed tooth databases, interactive learning lessons, a 3D tooth explorer,
     * a spaced repetition system for review, and a progress tracker.
     */
    const dentalAnatomySimulator = {
        /**
         * @property {object} teethDatabase - Contains detailed data about teeth, tissues, and anatomical terms.
         */
        teethDatabase: {
            /**
             * @property {Array<object>} quadrants - Array of tooth quadrants, each containing teeth data.
             */
            quadrants: [
                {
                    id: 'UR',
                    name: 'علوي يمين',
                    teeth: [
                        {
                            id: 1,
                            universal: 8,
                            name: 'القاطع المركزي العلوي',
                            type: 'قاطع',
                            function: 'قطع الطعام',
                            characteristics: [
                                'أكبر الأسنان القاطعة',
                                'حافة قاطعة مستقيمة',
                                'تاج على شكل مجداف',
                                'جذر واحد مخروطي'
                            ],
                            dimensions: {
                                crownLength: '10.5 مم',
                                rootLength: '13.0 مم',
                                mesiodistal: '8.6 مم',
                                faciolingual: '7.1 مم'
                            },
                            eruption: '7-8 سنوات',
                            rootCanals: 1,
                            uniqueFeature: 'الحافة القاطعة المستقيمة والزاوية الداخلية الحادة'
                        },
                        {
                            id: 2,
                            universal: 7,
                            name: 'القاطع الجانبي العلوي',
                            type: 'قاطع',
                            function: 'قطع الطعام',
                            characteristics: [
                                'أصغر من القاطع المركزي',
                                'تاج أكثر استدارة',
                                'حافة قاطعة مائلة',
                                'جذر واحد قد يكون منحني'
                            ],
                            dimensions: {
                                crownLength: '9.0 مم',
                                rootLength: '13.0 مم',
                                mesiodistal: '6.6 مم',
                                faciolingual: '6.2 مم'
                            },
                            eruption: '8-9 سنوات',
                            rootCanals: 1,
                            uniqueFeature: 'التاج المدور والجذر المنحني أحياناً'
                        },
                        {
                            id: 3,
                            universal: 6,
                            name: 'الناب العلوي',
                            type: 'ناب',
                            function: 'تمزيق الطعام',
                            characteristics: [
                                'أطول سن في الفم',
                                'نهاية مدببة حادة',
                                'جذر طويل وقوي',
                                'بروز على السطح الشدقي'
                            ],
                            dimensions: {
                                crownLength: '10.0 مم',
                                rootLength: '17.0 مم',
                                mesiodistal: '7.6 مم',
                                faciolingual: '8.1 مم'
                            },
                            eruption: '11-12 سنوات',
                            rootCanals: 1,
                            uniqueFeature: 'النهاية المدببة الحادة والجذر الأطول'
                        },
                        {
                            id: 4,
                            universal: 5,
                            name: 'الضاحك الأول العلوي',
                            type: 'ضاحك',
                            function: 'طحن وتمزيق الطعام',
                            characteristics: [
                                'شكل مستطيل',
                                'حدبتان (شدقية ولسانية)',
                                'الحدبة الشدقية أكبر',
                                'جذران في 60% من الحالات'
                            ],
                            dimensions: {
                                crownLength: '8.5 مم',
                                rootLength: '14.0 مم',
                                mesiodistal: '7.0 مم',
                                faciolingual: '9.0 مم'
                            },
                            eruption: '10-11 سنوات',
                            rootCanals: '1-2 (عادة 2)',
                            uniqueFeature: 'الحدبة الشدقية الأكبر ووجود أخدود وسطي'
                        },
                        {
                            id: 5,
                            universal: 4,
                            name: 'الضاحك الثاني العلوي',
                            type: 'ضاحك',
                            function: 'طحن الطعام',
                            characteristics: [
                                'أصغر من الضاحك الأول',
                                'الحدبتان متساويتان تقريباً',
                                'شكل أكثر استدارة',
                                'جذر واحد عادة'
                            ],
                            dimensions: {
                                crownLength: '8.0 مم',
                                rootLength: '14.0 مم',
                                mesiodistal: '6.5 مم',
                                faciolingual: '9.0 مم'
                            },
                            eruption: '10-12 سنوات',
                            rootCanals: '1 (أحياناً 2)',
                            uniqueFeature: 'الحدبتان المتساويتان والشكل المستدير'
                        },
                        {
                            id: 6,
                            universal: 3,
                            name: 'الطاحن الأول العلوي',
                            type: 'طاحن',
                            function: 'طحن الطعام الرئيسي',
                            characteristics: [
                                'أكبر الأسنان الطاحنة',
                                'أربع حدبات رئيسية',
                                'حدبة إضافية (حدبة كارابيلي)',
                                'ثلاثة جذور'
                            ],
                            dimensions: {
                                crownLength: '7.5 مم',
                                rootLength: '13.0 مم',
                                mesiodistal: '10.0 مم',
                                faciolingual: '11.5 مم'
                            },
                            eruption: '6-7 سنوات',
                            rootCanals: '3-4 (عادة 3)',
                            uniqueFeature: 'وجود حدبة كارابيلي والجذور الثلاثة'
                        }
                    ]
                }
            ],

            /**
             * @property {Array<object>} toothTissues - Detailed information about tooth tissues.
             */
            toothTissues: [
                {
                    name: 'المينا',
                    description: 'أقسى نسيج في جسم الإنسان',
                    composition: '96% معادن (هيدروكسي أباتايت)، 4% مواد عضوية وماء',
                    thickness: '2.5 مم على الحدبات، 1.0 مم على الجوانب',
                    color: 'أبيض شفاف إلى أصفر فاتح',
                    function: 'حماية الأسنان من التآكل والبكتيريا',
                    properties: ['غير قابلة للتجدد', 'غير حساسة', 'شديدة الصلابة'],
                    clinicalImportance: 'تسوس المينا هو بداية التسوس السني'
                },
                {
                    name: 'العاج',
                    description: 'النسيج الأساسي للسن',
                    composition: '70% معادن، 20% مواد عضوية، 10% ماء',
                    thickness: 'يشكل معظم بنية السن',
                    color: 'أصفر',
                    function: 'دعم المينا وتوصيل الإحساس',
                    properties: ['قابل للتجدد بشكل محدود', 'حساس', 'أقل صلابة من المينا'],
                    clinicalImportance: 'حساسية الأسنان تحدث عند تعرض العاج'
                },
                {
                    name: 'اللب',
                    description: 'الجزء الحي من السن',
                    composition: 'أنسجة ضامة، أوعية دموية، أعصاب',
                    location: 'حجرة اللب وقنوات الجذر',
                    color: 'وردي',
                    function: 'تغذية السن والإحساس',
                    properties: ['حساس جداً', 'قابل للالتهاب', 'يحتوي على خلايا بنائية'],
                    clinicalImportance: 'التهاب اللب يتطلب علاج الجذور'
                },
                {
                    name: 'الملاط',
                    description: 'النسيج الذي يغطي جذر السن',
                    composition: '65% معادن، 23% مواد عضوية، 12% ماء',
                    thickness: '50-200 ميكرون',
                    color: 'أصفر باهت',
                    function: 'ربط السن بالرباط اللثوي',
                    properties: ['قابل للتجدد', 'أقل صلابة من العاج', 'مرتبط بألياف شاربي'],
                    clinicalImportance: 'انسحاب اللثة يكشف الملاط ويسبب الحساسية'
                }
            ],

            /**
             * @property {Array<object>} anatomicalTerms - Definitions of common anatomical terms.
             */
            anatomicalTerms: [
                {
                    term: 'السطح الماضغ',
                    definition: 'السطح الذي يمضغ الطعام',
                    location: 'أعلى التاج في الأسنان الخلفية',
                    features: ['الحدبات', 'الأخاديد', 'الحفر']
                },
                {
                    term: 'السطح الشدقي',
                    definition: 'السطح المواجه للخد',
                    location: 'الجانب الخارجي للسن',
                    features: ['بروز شدقي', 'منطقة اتصال مع الخد']
                },
                {
                    term: 'السطح اللساني',
                    definition: 'السطح المواجه للسان',
                    location: 'الجانب الداخلي للسن',
                    features: ['حدبة لسانية', 'أخدود جانبي']
                },
                {
                    term: 'السطح المقارب',
                    definition: 'السطح المواجه للسن المجاور',
                    location: 'الجانب بين الأسنان',
                    features: ['نقطة تلامس', 'منطقة مثلثة']
                }
            ]
        },

        /**
         * @property {object} learningSystem - Manages interactive lessons and quizzes.
         */
        learningSystem: {
            /**
             * @property {object} currentStudent - Stores current student's progress and scores.
             */
            currentStudent: {
                name: 'طالب طب الأسنان',
                level: 'مبتدئ',
                progress: {},
                completedLessons: [],
                scores: {},
                currentMilestone: null // Initialized in dentalAnatomySimulator.init
            },

            /**
             * @property {Array<object>} anatomyLessons - Array of available anatomy lessons.
             */
            anatomyLessons: [
                {
                    id: 'lesson-1',
                    title: 'مقدمة في تشريح الأسنان',
                    description: 'تعرف على المصطلحات الأساسية وأجزاء السن',
                    duration: '15 دقيقة',
                    difficulty: 'سهل',
                    objectives: [
                        'التعرف على أجزاء السن الرئيسية',
                        'فهم مصطلحات التشريح السني',
                        'تمييز أنواع الأسنان المختلفة'
                    ],
                    content: [
                        {
                            type: 'text',
                            title: 'ما هو تشريح الأسنان؟',
                            text: 'تشريح الأسنان هو دراسة بنية وتركيب الأسنان. كل سن يتكون من تاج وجذر، ويحتوي على عدة أنسجة مختلفة.'
                        },
                        {
                            type: 'image',
                            title: 'أجزاء السن',
                            description: 'التاج: الجزء الظاهر فوق اللثة\nالجذر: الجزء المدفون في العظم\nعنق السن: منطقة الاتصال بين التاج والجذر'
                        },
                        {
                            type: 'interactive',
                            title: 'استكشف أجزاء السن',
                            activity: 'انقر على أجزاء السن المختلفة لمعرفة المزيد عنها'
                        }
                    ],
                    quiz: {
                        question: 'ما هو الجزء الظاهر من السن فوق اللثة؟',
                        options: ['الجذر', 'التاج', 'اللب', 'الملاط'],
                        correctAnswer: 1,
                        explanation: 'التاج هو الجزء الظاهر من السن فوق اللثة، بينما الجذر مدفون في العظم.'
                    }
                },
                {
                    id: 'lesson-2',
                    title: 'أنواع الأسنان ووظائفها',
                    description: 'تعرف على الأسنان القاطعة والأنياب والضواحك والطواحن',
                    duration: '20 دقيقة',
                    difficulty: 'متوسط',
                    objectives: [
                        'تمييز أنواع الأسنان الأربعة',
                        'فهم الوظيفة الخاصة بكل نوع',
                        'معرفة الخصائص التشريحية لكل نوع'
                    ],
                    content: [
                        {
                            type: 'comparison',
                            title: 'مقارنة بين أنواع الأسنان',
                            items: [
                                { name: 'القواطع', function: 'قطع الطعام', shape: 'شبه مجداف' },
                                { name: 'الأنياب', function: 'تمزيق الطعام', shape: 'مدبب' },
                                { name: 'الضواحك', function: 'طحن وتمزيق', shape: 'مربع بحدبتين' },
                                { name: 'الطواحن', function: 'طحن الطعام', shape: 'مكعب بأربع حدبات' }
                            ]
                        }
                    ],
                    quiz: {
                        question: 'أي الأسنان التالية مسؤولة عن تمزيق الطعام؟',
                        options: ['القواطع', 'الأنياب', 'الضواحك', 'الطواحن'],
                        correctAnswer: 1,
                        explanation: 'الأنياب تتميز بشكلها المدبب وهي متخصصة في تمزيق الطعام.'
                    }
                }
            ],

            /**
             * Starts a new lesson and displays its content.
             * @param {string} lessonId - The ID of the lesson to start.
             */
            startLesson: function(lessonId) {
                const lesson = this.anatomyLessons.find(l => l.id === lessonId);
                if (!lesson) return;
                
                this.currentStudent.currentLesson = lesson;
                this.displayLessonContent(lesson);
                
                showDentalAlert(`بدأت درس: ${lesson.title}`, 'info');
                dentalAnatomySimulator.progressTracker.recordActivity(`بدء درس: ${lesson.title}`, 2);
            },

            /**
             * Displays the content of a given lesson in the UI.
             * @param {object} lesson - The lesson object to display.
             */
            displayLessonContent: function(lesson) {
                const contentArea = document.getElementById('anatomy-learning-content');
                if (!contentArea) return;
                
                let contentHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="font-bold text-xl text-gray-800">${lesson.title}</h3>
                                <p class="text-gray-600">${lesson.description}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                                    ${lesson.duration}
                                </span>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                                    ${lesson.difficulty}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-700 mb-3">🎯 أهداف الدرس:</h4>
                            <ul class="list-disc list-inside text-gray-600 space-y-2">
                                ${lesson.objectives.map(obj => `<li>${obj}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="space-y-6 mb-8" id="lesson-content">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                        
                        <div class="border-t pt-6">
                            <button class="btn-dental w-full" onclick="dentalAnatomySimulator.learningSystem.completeLesson('${lesson.id}')">
                                <i class="fas fa-check-circle mr-2"></i> إكمال الدرس وبدء الاختبار
                            </button>
                        </div>
                    </div>
                `;
                
                contentArea.innerHTML = contentHTML;
                
                // عرض محتوى الدرس التفصيلي
                this.renderLessonDetails(lesson.content);
            },

            /**
             * Renders detailed lesson content items into the UI.
             * @param {Array<object>} contentItems - Array of content objects to render.
             */
            renderLessonDetails: function(contentItems) {
                const contentContainer = document.getElementById('lesson-content');
                if (!contentContainer) return;
                
                contentContainer.innerHTML = ''; // Clear previous content
                contentItems.forEach((item, index) => {
                    let itemHTML = '';
                    
                    switch(item.type) {
                        case 'text':
                            itemHTML = `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold text-gray-800 mb-2">${item.title}</h5>
                                    <p class="text-gray-600">${item.text}</p>
                                </div>
                            `;
                            break;
                            
                        case 'image':
                            itemHTML = `
                                <div class="text-center">
                                    <div class="bg-gradient-to-br from-blue-50 to-teal-50 p-6 rounded-lg mb-3">
                                        <i class="fas fa-tooth text-4xl text-blue-500 mb-3"></i>
                                        <h5 class="font-bold text-gray-800 mb-2">${item.title}</h5>
                                        <p class="text-gray-600 whitespace-pre-line">${item.description}</p>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'interactive':
                            itemHTML = `
                                <div class="interactive-tool">
                                    <h5 class="font-bold text-gray-800 mb-3">${item.title}</h5>
                                    <p class="text-gray-600 mb-4">${item.activity}</p>
                                    <div class="flex justify-center">
                                        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                                onclick="dentalAnatomySimulator.toothExplorer.startExploration()">
                                            <i class="fas fa-play mr-2"></i> بدء الاستكشاف
                                        </button>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'comparison':
                            itemHTML = `
                                <div class="bg-white border rounded-lg p-4">
                                    <h5 class="font-bold text-gray-800 mb-4">${item.title}</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        ${item.items.map(item => `
                                            <div class="border rounded-lg p-3 text-center">
                                                <div class="font-bold text-lg text-gray-800 mb-2">${item.name}</div>
                                                <div class="text-sm text-gray-600 mb-2">${item.function}</div>
                                                <div class="text-xs text-blue-600">${item.shape}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                            break;
                    }
                    
                    contentContainer.innerHTML += itemHTML;
                });
            },

            /**
             * Marks a lesson as complete and proceeds to its quiz.
             * @param {string} lessonId - The ID of the lesson to complete.
             */
            completeLesson: function(lessonId) {
                if (!this.currentStudent.completedLessons.includes(lessonId)) {
                    this.currentStudent.completedLessons.push(lessonId);
                    dentalAnatomySimulator.progressTracker.recordActivity(`إكمال درس: ${this.anatomyLessons.find(l => l.id === lessonId).title}`, 5);
                }
                
                // عرض اختبار الدرس
                this.showLessonQuiz(lessonId);
                
                showDentalAlert('تهانينا! أكملت الدرس بنجاح', 'success');
            },

            /**
             * Displays the quiz for a given lesson in a modal.
             * @param {string} lessonId - The ID of the lesson for which to show the quiz.
             */
            showLessonQuiz: function(lessonId) {
                const lesson = this.anatomyLessons.find(l => l.id === lessonId);
                if (!lesson || !lesson.quiz) return;
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-lg w-full">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">اختبار الدرس: ${lesson.title}</h3>
                        
                        <div class="mb-6">
                            <p class="text-gray-700 mb-4">${lesson.quiz.question}</p>
                            <div class="space-y-3" id="quiz-options">
                                ${lesson.quiz.options.map((option, index) => `
                                    <div class="quiz-option" onclick="dentalAnatomySimulator.learningSystem.selectQuizAnswer(${index}, '${lessonId}')">
                                        ${option}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div id="quiz-result" class="hidden">
                            <!-- سيتم ملؤها عند الإجابة -->
                        </div>
                        
                        <div class="flex justify-end">
                            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    onclick="this.parentElement.parentElement.parentElement.remove()">
                                إغلاق
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },

            /**
             * Handles the selection of a quiz answer, updates scores, and displays feedback.
             * @param {number} selectedIndex - The index of the selected answer.
             * @param {string} lessonId - The ID of the lesson quiz.
             */
            selectQuizAnswer: function(selectedIndex, lessonId) {
                const lesson = this.anatomyLessons.find(l => l.id === lessonId);
                if (!lesson) return;
                
                const isCorrect = selectedIndex === lesson.quiz.correctAnswer;
                
                // تحديث النتيجة
                if (!this.currentStudent.scores[lessonId]) {
                    this.currentStudent.scores[lessonId] = { attempts: 0, correct: 0 };
                }
                this.currentStudent.scores[lessonId].attempts++;
                if (isCorrect) {
                    this.currentStudent.scores[lessonId].correct++;
                    dentalAnatomySimulator.progressTracker.recordActivity(`إجابة صحيحة في اختبار ${lesson.title}`, 3);
                } else {
                    dentalAnatomySimulator.progressTracker.recordActivity(`إجابة خاطئة في اختبار ${lesson.title}`, 1);
                }
                
                // عرض النتيجة
                const resultDiv = document.getElementById('quiz-result');
                if (resultDiv) {
                    resultDiv.classList.remove('hidden');
                    resultDiv.innerHTML = `
                        <div class="p-4 rounded-lg ${isCorrect ? 'bg-green-100 border border-green-200' : 'bg-red-100 border border-red-200'} mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-${isCorrect ? 'check-circle text-green-600' : 'times-circle text-red-600'} mr-3"></i>
                                <div>
                                    <p class="font-bold ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                        ${isCorrect ? 'إجابة صحيحة! 🎉' : 'إجابة خاطئة'}
                                    </p>
                                    <p class="text-sm ${isCorrect ? 'text-green-600' : 'text-red-600'} mt-1">
                                        ${lesson.quiz.explanation}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <button class="w-full px-4 py-2 ${isCorrect ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg"
                                onclick="this.closest('.fixed').remove(); dentalAnatomySimulator.learningSystem.continueLearning('${lessonId}', ${isCorrect})">
                            ${isCorrect ? 'المتابعة للدرس التالي' : 'حاول مرة أخرى'}
                        </button>
                    `;
                }
                
                // تحديث خيارات الاختبار
                document.querySelectorAll('.quiz-option').forEach((option, index) => {
                    option.classList.remove('selected');
                    if (index === selectedIndex) {
                        option.classList.add('selected');
                        if (isCorrect) {
                            option.classList.add('bg-green-100', 'border-green-500');
                        } else {
                            option.classList.add('bg-red-100', 'border-red-500');
                        }
                    }
                    // Highlight correct answer if selected answer was wrong
                    if (index === lesson.quiz.correctAnswer && !isCorrect) {
                        option.classList.add('bg-green-100', 'border-green-500');
                    }
                });
            },

            /**
             * Continues learning after a quiz, either to the next lesson or retrying the current one.
             * @param {string} lessonId - The ID of the completed lesson.
             * @param {boolean} passed - True if the quiz was passed, false otherwise.
             */
            continueLearning: function(lessonId, passed) {
                if (passed) {
                    // عرض الدرس التالي إن وجد
                    const currentIndex = this.anatomyLessons.findIndex(l => l.id === lessonId);
                    if (currentIndex < this.anatomyLessons.length - 1) {
                        const nextLesson = this.anatomyLessons[currentIndex + 1];
                        this.startLesson(nextLesson.id);
                    } else {
                        showDentalAlert('تهانينا! أكملت جميع الدروس الأساسية', 'success');
                        dentalAnatomySimulator.progressTracker.recordActivity('إكمال جميع الدروس الأساسية', 10);
                    }
                } else {
                    // إعادة الدرس الحالي
                    this.startLesson(lessonId);
                }
            }
        },

        /**
         * @property {object} toothExplorer - Provides an interactive 3D model-like tooth exploration.
         */
        toothExplorer: {
            currentTooth: null,
            selectedPart: null,
            
            /**
             * Initiates the tooth exploration interface.
             */
            startExploration: function() {
                this.createExplorerInterface();
                this.selectTooth(1); // البدء بالسن الأول تلقائياً
                dentalAnatomySimulator.progressTracker.recordActivity('بدء استكشاف الأسنان', 2);
            },
            
            /**
             * Creates the main UI for the tooth explorer.
             */
            createExplorerInterface: function() {
                const anatomyContent = document.getElementById('anatomy-learning-content'); // Changed to anatomy-learning-content
                if (!anatomyContent) return;
                
                anatomyContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <!-- رأس الاستكشاف -->
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-xl text-gray-800">
                                    <i class="fas fa-search text-blue-500 mr-2"></i>
                                    مستكشف الأسنان التفاعلي
                                </h3>
                                <div class="text-sm text-gray-600">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">
                                        وضع التعلم
                                    </span>
                                </div>
                            </div>
                            
                            <!-- نموذج السن التفاعلي (مبسط) -->
                            <div class="simulation-container p-4 mb-6">
                                <div class="text-center mb-4">
                                    <h4 class="font-bold text-lg text-gray-800" id="current-tooth-name">اختر سن للاستكشاف</h4>
                                    <p class="text-gray-600" id="current-tooth-description">انقر على أحد الأسنان من القائمة</p>
                                </div>
                                
                                <div class="flex justify-center mb-6">
                                    <div class="relative w-64 h-64" id="tooth-model" style="transform: rotateY(0deg) scale(1);">
                                        <!-- نموذج السن البسيط (يمكن استبداله بـ 3D Model في المستقبل) -->
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="text-center text-gray-400">
                                                <i class="fas fa-tooth text-6xl mb-3"></i>
                                                <p>نموذج السن التفاعلي</p>
                                            </div>
                                        </div>
                                        
                                        <!-- أجزاء السن القابلة للنقر -->
                                        <div class="absolute top-[15%] right-[15%] w-3/5 h-2/5 border-2 border-blue-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all opacity-75"
                                             onclick="dentalAnatomySimulator.toothExplorer.selectPart('enamel')"
                                             title="المينا" style="z-index: 3;">
                                            <div class="text-xs text-center mt-2 text-blue-600 font-bold">المينا</div>
                                        </div>
                                        
                                        <div class="absolute top-[25%] right-[25%] w-2/5 h-2/5 border-2 border-green-300 rounded-lg cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all opacity-75"
                                             onclick="dentalAnatomySimulator.toothExplorer.selectPart('dentin')"
                                             title="العاج" style="z-index: 2;">
                                            <div class="text-xs text-center mt-2 text-green-600 font-bold">العاج</div>
                                        </div>
                                        
                                        <div class="absolute top-[35%] right-[35%] w-1/5 h-1/5 border-2 border-red-300 rounded-lg cursor-pointer hover:border-red-500 hover:bg-red-50 transition-all opacity-75"
                                             onclick="dentalAnatomySimulator.toothExplorer.selectPart('pulp')"
                                             title="اللب" style="z-index: 1;">
                                            <div class="text-xs text-center mt-2 text-red-600 font-bold">اللب</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- أدوات التحكم -->
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                            onclick="dentalAnatomySimulator.toothExplorer.rotateModel('left')">
                                        <i class="fas fa-undo mr-2"></i> تدوير
                                    </button>
                                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                            onclick="dentalAnatomySimulator.toothExplorer.zoomIn()">
                                        <i class="fas fa-search-plus mr-2"></i> تكبير
                                    </button>
                                    <button class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                                            onclick="dentalAnatomySimulator.toothExplorer.showCrossSection()">
                                        <i class="fas fa-cut mr-2"></i> مقطع عرضي
                                    </button>
                                    <button class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                            onclick="dentalAnatomySimulator.toothExplorer.testKnowledge()">
                                        <i class="fas fa-question-circle mr-2"></i> اختبر نفسك
                                    </button>
                                </div>
                            </div>
                            
                            <!-- اختيار الأسنان -->
                            <div class="mb-6">
                                <h4 class="font-bold text-lg text-gray-800 mb-4">اختر سن للدراسة:</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    ${dentalAnatomySimulator.teethDatabase.quadrants[0].teeth.map(tooth => `
                                        <div class="dental-card p-3 text-center cursor-pointer hover:shadow-lg transition-all duration-300 ${tooth.id === 1 ? 'border-2 border-blue-500' : ''}"
                                             onclick="dentalAnatomySimulator.toothExplorer.selectTooth(${tooth.id})">
                                            <div class="text-2xl mb-2">🦷</div>
                                            <h5 class="font-bold text-gray-800 text-sm">${tooth.name.split(' ')[0]}</h5>
                                            <p class="text-xs text-gray-600">${tooth.type}</p>
                                            <div class="mt-2">
                                                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                                                    #${tooth.universal}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- الشريط الجانبي للمعلومات -->
                        <div class="space-y-6">
                            <!-- معلومات السن -->
                            <div class="bg-gradient-to-br from-blue-50 to-teal-50 p-6 rounded-2xl shadow-lg">
                                <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                    معلومات السن
                                </h3>
                                <div id="tooth-info" class="space-y-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-tooth text-3xl mb-3 text-gray-400"></i>
                                        <p>اختر سن من القائمة لعرض معلوماته</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- معلومات الجزء المحدد -->
                            <div id="part-info-container" class="hidden">
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h4 class="font-bold text-lg text-gray-800 mb-4" id="part-name">المينا</h4>
                                    <div class="space-y-3" id="part-details">
                                        <!-- سيتم ملؤها ديناميكياً -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- جدول مقارنة -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h4 class="font-bold text-lg text-gray-800 mb-4">
                                    <i class="fas fa-balance-scale text-green-600 mr-2"></i>
                                    مقارنة الأنسجة
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="dental-table w-full">
                                        <thead>
                                            <tr>
                                                <th>النسيج</th>
                                                <th>الصلابة</th>
                                                <th>القدرة على التجدد</th>
                                                <th>الحساسية</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dentalAnatomySimulator.teethDatabase.toothTissues.map(tissue => `
                                                <tr>
                                                    <td class="font-medium">${tissue.name}</td>
                                                    <td>${tissue.name === 'المينا' ? 'عالية جداً' : tissue.name === 'العاج' ? 'عالية' : 'منخفضة'}</td>
                                                    <td>${tissue.properties.includes('غير قابلة للتجدد') ? 'لا' : tissue.properties.includes('قابل للتجدد بشكل محدود') ? 'محدودة' : 'نعم'}</td>
                                                    <td>${tissue.properties.includes('غير حساسة') ? 'لا' : tissue.properties.includes('حساس') ? 'نعم' : 'نعم جداً'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- حقائق مذهلة -->
                            <div class="dental-alert alert-info">
                                <h5 class="font-bold text-blue-700 mb-2">💡 حقائق مذهلة عن الأسنان:</h5>
                                <ul class="text-sm text-blue-600 space-y-1">
                                    <li>• المينا هي أقوى مادة في جسم الإنسان</li>
                                    <li>• لكل سن بصمة فريدة مثل البصمات</li>
                                    <li>• 99% من الكالسيوم في الجسم في الأسنان والعظام</li>
                                    <li>• الأسنان تبدأ في التكون قبل الولادة</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                showDentalAlert('بدأت جلسة استكشاف الأسنان. اختر سن للبدء!', 'info');
            },
            
            /**
             * Selects a tooth by its ID and updates the UI with its information.
             * @param {number} toothId - The ID of the tooth to select.
             */
            selectTooth: function(toothId) {
                const quadrant = dentalAnatomySimulator.teethDatabase.quadrants[0];
                this.currentTooth = quadrant.teeth.find(t => t.id === toothId);
                
                if (!this.currentTooth) return;
                
                // تحديث اسم السن
                document.getElementById('current-tooth-name').textContent = this.currentTooth.name;
                document.getElementById('current-tooth-description').textContent = this.currentTooth.function;
                
                // تحديث معلومات السن
                this.displayToothInfo();
                
                // تحديث النشاط البصري
                document.querySelectorAll('.dental-card').forEach(card => {
                    card.classList.remove('border-2', 'border-blue-500');
                });
                
                const selectedCard = document.querySelector(`[onclick*="selectTooth(${toothId})"]`);
                if (selectedCard) {
                    selectedCard.classList.add('border-2', 'border-blue-500');
                }
                
                showDentalAlert(`تم اختيار ${this.currentTooth.name}`, 'success');
                dentalAnatomySimulator.progressTracker.recordActivity(`استكشاف السن: ${this.currentTooth.name}`, 1);
            },
            
            /**
             * Displays the detailed information of the currently selected tooth.
             */
            displayToothInfo: function() {
                const infoContainer = document.getElementById('tooth-info');
                if (!infoContainer || !this.currentTooth) return;
                
                infoContainer.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">🦷</div>
                        <h4 class="font-bold text-xl text-gray-800">${this.currentTooth.name}</h4>
                        <p class="text-gray-600">${this.currentTooth.type} - ${this.currentTooth.function}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">رقم عالمي:</span>
                            <span class="font-bold">${this.currentTooth.universal}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">بزوغ:</span>
                            <span class="font-bold">${this.currentTooth.eruption}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">عدد قنوات الجذر:</span>
                            <span class="font-bold">${this.currentTooth.rootCanals}</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="font-bold text-gray-700 mb-2">الخصائص المميزة:</h5>
                        <ul class="text-sm text-gray-600 space-y-1">
                            ${this.currentTooth.characteristics.map(char => `<li>• ${char}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <h5 class="font-bold text-gray-700 mb-2">📏 الأبعاد:</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-center">
                                <div class="text-gray-500">طول التاج</div>
                                <div class="font-bold">${this.currentTooth.dimensions.crownLength}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-gray-500">طول الجذر</div>
                                <div class="font-bold">${this.currentTooth.dimensions.rootLength}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-sm text-blue-600 font-medium">
                            <i class="fas fa-lightbulb mr-1"></i>
                            ${this.currentTooth.uniqueFeature}
                        </p>
                    </div>
                `;
            },
            
            /**
             * Selects a specific part of the tooth (e.g., enamel, dentin, pulp) and displays its details.
             * @param {string} partName - The name of the tooth part to select.
             */
            selectPart: function(partName) {
                this.selectedPart = partName;
                
                // إظهار معلومات الجزء
                document.getElementById('part-info-container').classList.remove('hidden');
                
                const tissue = dentalAnatomySimulator.teethDatabase.toothTissues.find(t => 
                    t.name === (partName === 'enamel' ? 'المينا' : 
                               partName === 'dentin' ? 'العاج' : 'اللب')
                );
                
                if (!tissue) return;
                
                document.getElementById('part-name').textContent = tissue.name;
                
                const partDetails = document.getElementById('part-details');
                partDetails.innerHTML = `
                    <div>
                        <p class="text-gray-600 mb-3">${tissue.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 p-2 rounded text-center">
                            <div class="text-xs text-gray-500">التركيب</div>
                            <div class="text-sm font-bold">${tissue.composition.split('،')[0]}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded text-center">
                            <div class="text-xs text-gray-500">الوظيفة</div>
                            <div class="text-sm font-bold">${tissue.function}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-bold text-gray-700 mb-2">الخصائص:</h6>
                        <div class="flex flex-wrap gap-2">
                            ${tissue.properties.map(prop => `
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                    ${prop}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-xs text-yellow-700">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            ${tissue.clinicalImportance}
                        </p>
                    </div>
                `;
                dentalAnatomySimulator.progressTracker.recordActivity(`استكشاف جزء: ${tissue.name}`, 1);
                showDentalAlert(`اخترت ${tissue.name}. تعرف أكثر على هذا النسيج المهم!`, 'info');
            },
            
            /**
             * Rotates the simplified tooth model visually.
             * @param {string} direction - 'left' or 'right' to rotate the model.
             */
            rotateModel: function(direction) {
                const model = document.getElementById('tooth-model');
                if (model) {
                    const currentRotation = model.style.transform.match(/rotateY\(([^)]+)\)/);
                    const currentAngle = currentRotation ? parseInt(currentRotation[1]) : 0;
                    const newAngle = direction === 'left' ? currentAngle - 90 : currentAngle + 90;
                    model.style.transform = `rotateY(${newAngle}deg) scale(${model.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1})`;
                    showDentalAlert(`تم تدوير النموذج إلى ${newAngle} درجة`, 'info');
                    dentalAnatomySimulator.progressTracker.recordActivity('تدوير نموذج السن', 0.5);
                }
            },
            
            /**
             * Zooms in on the simplified tooth model visually.
             */
            zoomIn: function() {
                const model = document.getElementById('tooth-model');
                if (model) {
                    const currentScale = model.style.transform.match(/scale\(([^)]+)\)/);
                    const current = currentScale ? parseFloat(currentScale[1]) : 1;
                    const newScale = Math.min(2, current * 1.2); // Cap zoom at 2x
                    model.style.transform = `rotateY(${model.style.transform.match(/rotateY\(([^)]+)\)/)?.[1] || 0}deg) scale(${newScale})`;
                    showDentalAlert('تم تكبير النموذج', 'info');
                    dentalAnatomySimulator.progressTracker.recordActivity('تكبير نموذج السن', 0.5);
                }
            },
            
            /**
             * Simulates showing a cross-section of the tooth model.
             */
            showCrossSection: function() {
                showDentalAlert('عرض المقطع العرضي: يمكنك رؤية العلاقة بين المينا والعاج واللب', 'info');
                dentalAnatomySimulator.progressTracker.recordActivity('عرض مقطع عرضي للسن', 1);
                
                // تأثير بصري بسيط
                const model = document.getElementById('tooth-model');
                if (model) {
                    model.classList.add('pulse-animation');
                    setTimeout(() => {
                        model.classList.remove('pulse-animation');
                    }, 1000);
                }
            },
            
            /**
             * Initiates a knowledge test for the currently selected tooth.
             */
            testKnowledge: function() {
                if (!this.currentTooth) {
                    showDentalAlert('اختر سن أولاً لاختبار معرفتك به', 'warning');
                    return;
                }
                
                const questions = [
                    {
                        question: `ما هو نوع السن ${this.currentTooth.name}؟`,
                        options: ['قاطع', 'ناب', 'ضاحك', 'طاحن'],
                        correctAnswer: this.currentTooth.type === 'قاطع' ? 0 : 
                                       this.currentTooth.type === 'ناب' ? 1 : 
                                       this.currentTooth.type === 'ضاحك' ? 2 : 3,
                        explanation: `الإجابة الصحيحة هي: ${this.currentTooth.type}. هذا السن يصنف كـ ${this.currentTooth.type}.`
                    },
                    {
                        question: `ما هي الوظيفة الرئيسية للسن ${this.currentTooth.name}؟`,
                        options: ['قطع الطعام', 'تمزيق الطعام', 'طحن الطعام', 'جميع ما سبق'],
                        correctAnswer: this.currentTooth.function.includes('قطع') ? 0 : 
                                       this.currentTooth.function.includes('تمزيق') ? 1 : 
                                       this.currentTooth.function.includes('طحن') ? 2 : 3,
                        explanation: `الإجابة الصحيحة هي: ${this.currentTooth.function}. وظيفته الرئيسية هي ${this.currentTooth.function}.`
                    },
                    {
                        question: `كم عدد قنوات الجذر في السن ${this.currentTooth.name} عادة؟`,
                        options: ['1', '2', '3', '4'],
                        correctAnswer: (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('1')) ? 0 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('2')) ? 1 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('3')) ? 2 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('4')) ? 3 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 1) ? 0 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 2) ? 1 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 3) ? 2 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 4) ? 3 : 0, // Default to 1 if parsing fails
                        explanation: `عادة، هذا السن يحتوي على ${this.currentTooth.rootCanals} من قنوات الجذر.`
                    }
                ];
                
                this.displayKnowledgeTest(questions);
                dentalAnatomySimulator.progressTracker.recordActivity(`بدء اختبار معرفة السن: ${this.currentTooth.name}`, 2);
            },
            
            /**
             * Displays the knowledge test questions in a modal.
             * @param {Array<object>} questions - An array of question objects.
             */
            displayKnowledgeTest: function(questions) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-lg w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800">اختبار معرفتك بالسن</h3>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4 text-center">
                            <div class="text-3xl mb-2">🦷</div>
                            <h4 class="font-bold text-gray-700">${this.currentTooth.name}</h4>
                        </div>
                        
                        <div id="test-questions" class="space-y-6">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                        
                        <div class="mt-6">
                            <button class="btn-dental w-full" onclick="dentalAnatomySimulator.toothExplorer.submitTest()">
                                <i class="fas fa-paper-plane mr-2"></i> تصحيح الإجابات
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // عرض الأسئلة
                const questionsContainer = document.getElementById('test-questions');
                questions.forEach((q, qIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'border rounded-lg p-4';
                    questionDiv.innerHTML = `
                        <h5 class="font-bold text-gray-700 mb-3">${qIndex + 1}. ${q.question}</h5>
                        <div class="space-y-2">
                            ${q.options.map((option, oIndex) => `
                                <div class="quiz-option test-option" data-question="${qIndex}" data-answer="${oIndex}">
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-3 hidden" id="explanation-${qIndex}">
                            <!-- سيتم ملؤها عند التصحيح -->
                        </div>
                    `;
                    questionsContainer.appendChild(questionDiv);
                    
                    // إضافة حدث النقر
                    questionDiv.querySelectorAll('.test-option').forEach(option => {
                        option.addEventListener('click', function() {
                            // إزالة التحديد من جميع خيارات هذا السؤال
                            const questionOptions = this.closest('.border').querySelectorAll('.test-option');
                            questionOptions.forEach(opt => opt.classList.remove('selected', 'bg-green-100', 'border-green-500', 'bg-red-100', 'border-red-500'));
                            
                            // تحديد الخيار المختار
                            this.classList.add('selected');
                            
                            // حفظ الإجابة
                            const questionIndex = parseInt(this.dataset.question);
                            const answerIndex = parseInt(this.dataset.answer);
                            
                            if (!window.testAnswers) window.testAnswers = {};
                            window.testAnswers[questionIndex] = answerIndex;
                        });
                    });
                });
            },
            
            /**
             * Submits the knowledge test, calculates results, and displays feedback.
             */
            submitTest: function() {
                if (!window.testAnswers) {
                    showDentalAlert('لم تختر أي إجابات بعد', 'warning');
                    return;
                }
                
                let correctCount = 0;
                const questions = [ // Redefine questions with explanations for display consistency
                    {
                        question: `ما هو نوع السن ${this.currentTooth.name}؟`,
                        options: ['قاطع', 'ناب', 'ضاحك', 'طاحن'],
                        correctAnswer: this.currentTooth.type === 'قاطع' ? 0 : 
                                       this.currentTooth.type === 'ناب' ? 1 : 
                                       this.currentTooth.type === 'ضاحك' ? 2 : 3,
                        explanation: `الإجابة الصحيحة هي: ${this.currentTooth.type}. هذا السن يصنف كـ ${this.currentTooth.type}.`
                    },
                    {
                        question: `ما هي الوظيفة الرئيسية للسن ${this.currentTooth.name}؟`,
                        options: ['قطع الطعام', 'تمزيق الطعام', 'طحن الطعام', 'جميع ما سبق'],
                        correctAnswer: this.currentTooth.function.includes('قطع') ? 0 : 
                                       this.currentTooth.function.includes('تمزيق') ? 1 : 
                                       this.currentTooth.function.includes('طحن') ? 2 : 3,
                        explanation: `الإجابة الصحيحة هي: ${this.currentTooth.function}. وظيفته الرئيسية هي ${this.currentTooth.function}.`
                    },
                    {
                        question: `كم عدد قنوات الجذر في السن ${this.currentTooth.name} عادة؟`,
                        options: ['1', '2', '3', '4'],
                        correctAnswer: (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('1')) ? 0 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('2')) ? 1 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('3')) ? 2 : 
                                       (typeof this.currentTooth.rootCanals === 'string' && this.currentTooth.rootCanals.includes('4')) ? 3 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 1) ? 0 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 2) ? 1 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 3) ? 2 : 
                                       (typeof this.currentTooth.rootCanals === 'number' && this.currentTooth.rootCanals === 4) ? 3 : 0, 
                        explanation: `عادة، هذا السن يحتوي على ${this.currentTooth.rootCanals} من قنوات الجذر.`
                    }
                ];
                
                // حساب النتيجة
                questions.forEach((q, index) => {
                    if (window.testAnswers[index] === q.correctAnswer) {
                        correctCount++;
                        dentalAnatomySimulator.progressTracker.recordActivity(`اجتياز سؤال اختبار عن ${this.currentTooth.name}`, 1);
                    } else {
                        dentalAnatomySimulator.progressTracker.recordActivity(`خطأ في سؤال اختبار عن ${this.currentTooth.name}`, 0.5);
                    }
                    
                    // عرض التصحيح لكل سؤال
                    const explanationDiv = document.getElementById(`explanation-${index}`);
                    if (explanationDiv) {
                        explanationDiv.classList.remove('hidden');
                        explanationDiv.innerHTML = `
                            <div class="p-2 rounded ${window.testAnswers[index] === q.correctAnswer ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                <i class="fas fa-${window.testAnswers[index] === q.correctAnswer ? 'check-circle' : 'times-circle'} mr-2"></i>
                                ${q.explanation}
                            </div>
                        `;
                    }
                    
                    // Highlight selected and correct options
                    const questionOptions = document.querySelectorAll(`[data-question="${index}"]`);
                    questionOptions.forEach(option => {
                        const optionIndex = parseInt(option.dataset.answer);
                        if (optionIndex === window.testAnswers[index]) {
                            option.classList.add('selected');
                            if (optionIndex === q.correctAnswer) {
                                option.classList.add('bg-green-100', 'border-green-500');
                            } else {
                                option.classList.add('bg-red-100', 'border-red-500');
                            }
                        } else if (optionIndex === q.correctAnswer) {
                            option.classList.add('bg-green-100', 'border-green-500'); // Highlight correct even if not selected
                        }
                    });
                });
                
                const percentage = Math.round((correctCount / questions.length) * 100);
                
                // عرض النتيجة النهائية
                const resultModal = document.createElement('div');
                resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                resultModal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-md w-full">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 rounded-full ${percentage >= 70 ? 'bg-gradient-to-br from-green-400 to-green-600' : 'bg-gradient-to-br from-yellow-400 to-orange-500'} 
                                  flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-${percentage >= 70 ? 'trophy' : 'graduation-cap'} text-white text-3xl"></i>
                            </div>
                            <h3 class="font-bold text-2xl text-gray-800 mb-2">نتيجة الاختبار</h3>
                            <p class="text-gray-600">${this.currentTooth.name}</p>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded text-center">
                                    <p class="text-sm text-gray-500">الإجابات الصحيحة</p>
                                    <p class="text-3xl font-bold ${percentage >= 70 ? 'text-green-600' : 'text-yellow-600'}">
                                        ${correctCount}/${questions.length}
                                    </p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded text-center">
                                    <p class="text-sm text-gray-500">النسبة المئوية</p>
                                    <p class="text-3xl font-bold text-blue-600">${percentage}%</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded">
                                <h4 class="font-bold text-gray-700 mb-2">📊 تقييم أدائك:</h4>
                                <p class="text-gray-600">
                                    ${percentage >= 90 ? 
                                        'ممتاز! لديك معرفة قوية بتشريح هذا السن. 👏' : 
                                      percentage >= 70 ? 
                                        'جيد جداً! فهمك لتشريح السن مقبول ولكن يحتاج لبعض المراجعة.' : 
                                      percentage >= 50 ? 
                                        'مقبول. ننصحك بمراجعة دروس التشريح مرة أخرى.' : 
                                        'يحتاج تحسين. راجع دروس التشريح وحاول مرة أخرى.'}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4">
                            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    onclick="this.parentElement.parentElement.remove(); document.querySelector('.fixed').remove()">
                                إغلاق
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    onclick="document.querySelectorAll('.fixed').forEach(el => el.remove()); dentalAnatomySimulator.toothExplorer.testKnowledge()">
                                <i class="fas fa-redo mr-2"></i> حاول مرة أخرى
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(resultModal);
                
                // تنظيف الإجابات
                window.testAnswers = null;
            }
        },

        /**
         * @property {object} spacedRepetition - Manages a spaced repetition system for long-term memory.
         */
        spacedRepetition: {
            reviewQueue: [],
            
            /**
             * Adds an item to the review queue with a calculated next review date.
             * @param {object} item - The item to add to review (e.g., tooth, tissue).
             * @param {string} difficulty - Initial difficulty ('easy', 'medium', 'hard').
             */
            addToReview: function(item, difficulty) {
                const reviewItem = {
                    id: item.id || item.name, // Unique identifier for the item
                    item: item,
                    difficulty: difficulty, // 'easy', 'medium', 'hard'
                    nextReview: this.calculateNextReview(difficulty, 0), // Initial interval 0
                    interval: 1, // Days
                    reviews: 0
                };
                
                // Prevent duplicates based on id
                if (!this.reviewQueue.some(r => r.id === reviewItem.id)) {
                    this.reviewQueue.push(reviewItem);
                    this.sortReviewQueue();
                    showDentalAlert(`تم إضافة "${item.name || item.title}" إلى قائمة المراجعة`, 'info');
                }
            },
            
            /**
             * Calculates the next review date based on difficulty and current interval.
             * @param {string} difficulty - The perceived difficulty ('easy', 'medium', 'hard').
             * @param {number} currentInterval - The current interval in days.
             * @returns {Date} The calculated next review date.
             */
            calculateNextReview: function(difficulty, currentInterval) {
                const now = new Date();
                let daysToAdd = 1;
                
                // SuperMemo 2-like algorithm adaptation
                if (currentInterval === 0) { // First review
                    daysToAdd = 1;
                } else if (currentInterval === 1) { // Second review
                    daysToAdd = 6;
                } else { // Subsequent reviews
                    switch(difficulty) {
                        case 'easy':
                            daysToAdd = Math.round(currentInterval * 2.5);
                            break;
                        case 'medium':
                            daysToAdd = Math.round(currentInterval * 1.5);
                            break;
                        case 'hard':
                            daysToAdd = Math.round(currentInterval * 0.5); // Shorten interval for hard items
                            break;
                        default:
                            daysToAdd = currentInterval + 1;
                    }
                }
                
                now.setDate(now.getDate() + daysToAdd);
                return now;
            },
            
            /**
             * Sorts the review queue by the next review date.
             */
            sortReviewQueue: function() {
                this.reviewQueue.sort((a, b) => a.nextReview - b.nextReview);
            },
            
            /**
             * Retrieves items scheduled for review today or earlier.
             * @returns {Array<object>} A list of items due for review.
             */
            getTodaysReviews: function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return this.reviewQueue.filter(item => {
                    const reviewDate = new Date(item.nextReview);
                    reviewDate.setHours(0, 0, 0, 0);
                    return reviewDate <= today;
                });
            },
            
            /**
             * Displays the daily review session if there are items due.
             */
            showDailyReview: function() {
                const todaysReviews = this.getTodaysReviews();
                if (todaysReviews.length === 0) {
                    showDentalAlert('لا توجد مراجعات لهذا اليوم. أحسنت! 🎉', 'success');
                    return;
                }
                
                this.displayReviewSession(todaysReviews);
                dentalAnatomySimulator.progressTracker.recordActivity('بدء جلسة مراجعة', 2);
            },
            
            /**
             * Renders the review session modal with due items.
             * @param {Array<object>} reviews - The list of review items for the session.
             */
            displayReviewSession: function(reviews) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="font-bold text-xl text-gray-800">📚 مراجعة اليوم</h3>
                                <p class="text-gray-600">${reviews.length} عنصر للمراجعة</p>
                            </div>
                            <div class="text-sm text-gray-500">
                                التكرار المتباعد لتعزيز الذاكرة طويلة المدى
                            </div>
                        </div>
                        
                        <div class="space-y-4" id="review-items">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                        
                        <div class="mt-6 pt-6 border-t">
                            <button class="btn-dental w-full" onclick="dentalAnatomySimulator.spacedRepetition.completeReview()">
                                <i class="fas fa-check-circle mr-2"></i> إنهاء المراجعة
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // عرض عناصر المراجعة
                const reviewContainer = document.getElementById('review-items');
                reviews.forEach((review, index) => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'border rounded-lg p-4';
                    reviewDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-gray-800">${review.item.name || review.item.title}</h4>
                            <span class="px-2 py-1 ${review.difficulty === 'easy' ? 'bg-green-100 text-green-700' : 
                                                   review.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-700' : 
                                                   'bg-red-100 text-red-700'} rounded text-xs">
                                ${review.difficulty === 'easy' ? 'سهل' : review.difficulty === 'medium' ? 'متوسط' : 'صعب'}
                            </span>
                        </div>
                        
                        ${review.item.description ? `
                            <p class="text-gray-600 mb-3">${review.item.description}</p>
                        ` : ''}
                        
                        ${review.item.characteristics ? `
                            <div class="mb-3">
                                <p class="text-sm font-medium text-gray-700 mb-1">الخصائص:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${review.item.characteristics.slice(0, 3).map(char => `
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                            ${char}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 mb-2">كيف كانت صعوبة تذكر هذه المعلومات؟</p>
                            <div class="flex justify-between">
                                <button class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
                                        onclick="dentalAnatomySimulator.spacedRepetition.rateDifficulty(${index}, 'easy')">
                                    <i class="fas fa-smile mr-1"></i> سهل
                                </button>
                                <button class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm"
                                        onclick="dentalAnatomySimulator.spacedRepetition.rateDifficulty(${index}, 'medium')">
                                    <i class="fas fa-meh mr-1"></i> متوسط
                                </button>
                                <button class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
                                        onclick="dentalAnatomySimulator.spacedRepetition.rateDifficulty(${index}, 'hard')">
                                    <i class="fas fa-frown mr-1"></i> صعب
                                </button>
                            </div>
                        </div>
                    `;
                    
                    reviewContainer.appendChild(reviewDiv);
                });
            },
            
            /**
             * Rates the difficulty of recalling a review item and updates its review schedule.
             * @param {number} index - The index of the item in the current review session.
             * @param {string} difficulty - The new perceived difficulty ('easy', 'medium', 'hard').
             */
            rateDifficulty: function(index, difficulty) {
                const reviewItem = this.reviewQueue.find((_, i) => i === index); // Find by original index in queue
                if (reviewItem) {
                    reviewItem.difficulty = difficulty;
                    
                    // Update interval based on difficulty and previous interval
                    let newInterval = reviewItem.interval;
                    switch(difficulty) {
                        case 'easy':
                            newInterval = Math.round(reviewItem.interval * 2.5);
                            break;
                        case 'medium':
                            newInterval = Math.round(reviewItem.interval * 1.5);
                            break;
                        case 'hard':
                            newInterval = Math.round(reviewItem.interval * 0.5); // Reduce interval for harder items
                            if (newInterval < 1) newInterval = 1; // Minimum 1 day
                            break;
                    }
                    reviewItem.interval = newInterval;
                    reviewItem.nextReview = this.calculateNextReview(difficulty, reviewItem.interval);
                    reviewItem.reviews++;
                    
                    // Visual feedback
                    const reviewElement = document.querySelectorAll('#review-items > div')[index];
                    if (reviewElement) {
                        reviewElement.classList.add('bg-green-50', 'border-green-200'); // Temp highlight
                        setTimeout(() => reviewElement.classList.remove('bg-green-50', 'border-green-200'), 1000);
                    }
                    
                    dentalAnatomySimulator.progressTracker.recordActivity(`تقييم مراجعة: ${reviewItem.item.name || reviewItem.item.title} كـ ${difficulty}`, 1);
                    showDentalAlert('تم تحديث صعوبة التذكر. سيتم عرضه مجدداً في الوقت المناسب.', 'success');
                }
            },
            
            /**
             * Completes the current review session and sorts the queue.
             */
            completeReview: function() {
                this.sortReviewQueue();
                document.querySelectorAll('.fixed').forEach(el => el.remove());
                
                dentalAnatomySimulator.progressTracker.recordActivity('إنهاء جلسة مراجعة يومية', 3);
                showDentalAlert('أحسنت! أكملت مراجعة اليوم. استمر في المذاكرة المنتظمة.', 'success');
            }
        },

        /**
         * @property {object} progressTracker - Tracks student progress, milestones, and activities.
         */
        progressTracker: {
            milestones: [
                { id: 1, name: 'المبتدئ', description: 'تعرفت على أساسيات التشريح', threshold: 3 },
                { id: 2, name: 'المتوسط', description: 'فهمت أنواع الأسنان ووظائفها', threshold: 10 },
                { id: 3, name: 'المتقدم', description: 'أتقنت تفاصيل أنسجة السن', threshold: 25 },
                { id: 4, name: 'الخبير', description: 'يمكنك التعرف على أي سن وتشريحه', threshold: 50 }
            ],
            
            /**
             * Records an activity and updates student progress.
             * @param {string} activity - The name of the activity.
             * @param {number} points - Points awarded for the activity.
             */
            recordActivity: function(activity, points = 1) {
                const student = dentalAnatomySimulator.learningSystem.currentStudent;
                
                if (!student.progress[activity]) {
                    student.progress[activity] = { count: 0, points: 0 };
                }
                
                student.progress[activity].count++;
                student.progress[activity].points += points;
                
                this.checkMilestones();
                this.updateProgressDisplay();
            },
            
            /**
             * Checks if any new milestones have been achieved.
             */
            checkMilestones: function() {
                const totalPoints = this.calculateTotalPoints();
                const currentMilestone = this.getCurrentMilestone(totalPoints);
                
                // التحقق إذا تم الوصول لمعلم جديد
                const previousMilestoneId = dentalAnatomySimulator.learningSystem.currentStudent.currentMilestone;
                if (currentMilestone.id !== previousMilestoneId) {
                    dentalAnatomySimulator.learningSystem.currentStudent.currentMilestone = currentMilestone.id;
                    this.showMilestoneAchieved(currentMilestone);
                }
            },
            
            /**
             * Calculates the total points earned by the student.
             * @returns {number} The total points.
             */
            calculateTotalPoints: function() {
                const student = dentalAnatomySimulator.learningSystem.currentStudent;
                let total = 0;
                
                for (const activity in student.progress) {
                    total += student.progress[activity].points;
                }
                
                return total;
            },
            
            /**
             * Determines the current milestone based on earned points.
             * @param {number} points - The student's total points.
             * @returns {object} The current milestone object.
             */
            getCurrentMilestone: function(points) {
                let current = this.milestones[0];
                
                for (const milestone of this.milestones) {
                    if (points >= milestone.threshold) {
                        current = milestone;
                    } else {
                        // Milestones are sorted by threshold, so once threshold is not met,
                        // the previous milestone is the current one.
                        break;
                    }
                }
                
                return current;
            },
            
            /**
             * Displays a modal when a new milestone is achieved.
             * @param {object} milestone - The milestone object that was achieved.
             */
            showMilestoneAchieved: function(milestone) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 
                              flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-trophy text-white text-4xl"></i>
                        </div>
                        
                        <h3 class="font-bold text-2xl text-gray-800 mb-2">🎉 إنجاز جديد!</h3>
                        <p class="text-gray-600 mb-1">لقد وصلت إلى مستوى</p>
                        <p class="text-xl font-bold text-blue-600 mb-4">${milestone.name}</p>
                        <p class="text-gray-700 mb-6">${milestone.description}</p>
                        
                        <button class="btn-dental" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-check mr-2"></i> ممتاز!
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // إضافة تأثير صوتي (إذا كان متاحاً)
                setTimeout(() => {
                    // Placeholder for actual sound. Ensure the audio file exists if used.
                    // const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQ=');
                    // audio.play().catch(() => {});
                }, 300);
            },
            
            /**
             * Updates the progress bar and milestone text in the UI.
             */
            updateProgressDisplay: function() {
                const totalPoints = this.calculateTotalPoints();
                const currentMilestone = this.getCurrentMilestone(totalPoints);
                const nextMilestone = this.milestones.find(m => m.threshold > currentMilestone.threshold);
                
                let progressPercentage = 0;
                let milestoneProgressText = `${currentMilestone.name}`;
            
                if (nextMilestone) {
                    const pointsNeededForNext = nextMilestone.threshold - currentMilestone.threshold;
                    const pointsEarnedInCurrentStage = totalPoints - currentMilestone.threshold;
                    
                    if (pointsNeededForNext > 0) {
                        progressPercentage = Math.min(100, (pointsEarnedInCurrentStage / pointsNeededForNext) * 100);
                        milestoneProgressText += ` (${pointsEarnedInCurrentStage}/${pointsNeededForNext} للنقطة التالية)`;
                    } else { // Current milestone is the last one or threshold is 0
                         progressPercentage = 100;
                    }
                } else { // Already at the highest milestone
                    progressPercentage = 100;
                    milestoneProgressText = `الخبير (أعلى مستوى)`;
                }
                
                // تحديث شريط التقدم في الواجهة إذا كان موجوداً
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${progressPercentage}%`;
                    progressBar.textContent = `${Math.round(progressPercentage)}%`;
                }
                
                const milestoneText = document.getElementById('current-milestone');
                if (milestoneText) {
                    milestoneText.textContent = milestoneProgressText;
                }
                
                const totalPointsDisplay = document.getElementById('total-learning-points');
                if (totalPointsDisplay) {
                    totalPointsDisplay.textContent = totalPoints;
                }
            },
            
            /**
             * Displays a modal with the student's progress dashboard.
             */
            showProgressDashboard: function() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-xl text-gray-800">📊 لوحة التقدم التعليمي</h3>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-50 to-teal-50 p-4 rounded-xl text-center">
                                <div class="text-3xl font-bold text-blue-600 mb-2" id="total-dashboard-points">${this.calculateTotalPoints()}</div>
                                <p class="text-gray-700">النقاط التعليمية</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl text-center">
                                <div class="text-3xl font-bold text-green-600 mb-2">
                                    ${dentalAnatomySimulator.learningSystem.currentStudent.completedLessons.length}
                                </div>
                                <p class="text-gray-700">الدروس المكتملة</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-xl text-center">
                                <div class="text-3xl font-bold text-purple-600 mb-2">
                                    ${Object.keys(dentalAnatomySimulator.learningSystem.currentStudent.scores).length}
                                </div>
                                <p class="text-gray-700">الاختبارات المقدمة</p>
                            </div>
                        </div>
                        
                        <div class="mb-8">
                            <h4 class="font-bold text-gray-700 mb-4">🎯 مسار التقدم:</h4>
                            <div class="space-y-4">
                                ${this.milestones.map(milestone => {
                                    const totalPoints = this.calculateTotalPoints();
                                    const isCompleted = totalPoints >= milestone.threshold;
                                    const isCurrent = this.getCurrentMilestone(totalPoints).id === milestone.id;
                                    
                                    return `
                                        <div class="flex items-center p-3 rounded-lg ${isCompleted ? 'bg-green-50 border border-green-200' : 
                                                                                   isCurrent ? 'bg-blue-50 border border-blue-200' : 
                                                                                   'bg-gray-50'}"}>
                                            <div class="w-8 h-8 rounded-full ${isCompleted ? 'bg-green-500' : 
                                                                              isCurrent ? 'bg-blue-500' : 
                                                                              'bg-gray-300'} 
                                                  flex items-center justify-center text-white font-bold mr-3">
                                                ${isCompleted ? '✓' : milestone.id}
                                            </div>
                                            <div class="flex-grow">
                                                <div class="font-bold ${isCompleted ? 'text-green-700' : 
                                                                       isCurrent ? 'text-blue-700' : 
                                                                       'text-gray-700'}">
                                                    ${milestone.name}
                                                </div>
                                                <div class="text-sm text-gray-600">${milestone.description}</div>
                                            </div>
                                            <div class="text-sm ${isCompleted ? 'text-green-600' : 'text-gray-500'}">
                                                ${milestone.threshold} نقطة
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-700 mb-4">📈 نشاطات التعلم:</h4>
                            <div class="space-y-3">
                                ${Object.entries(dentalAnatomySimulator.learningSystem.currentStudent.progress)
                                    .sort(([, a], [, b]) => b.points - a.points) // Sort by points desc
                                    .slice(0, 5) // Show top 5
                                    .map(([activity, data]) => `
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <div>
                                                <span class="font-medium text-gray-800">${activity}</span>
                                                <span class="text-xs text-gray-600 mr-2">(${data.count} مرة)</span>
                                            </div>
                                            <div class="text-green-600 font-bold">${data.points} نقطة</div>
                                        </div>
                                    `).join('')}
                            </div>
                            ${Object.keys(dentalAnatomySimulator.learningSystem.currentStudent.progress).length > 5 ? `
                                <div class="text-center mt-4">
                                    <p class="text-sm text-gray-500">والمزيد من الأنشطة...</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="text-center text-sm text-gray-500">
                            <p>💡 استمر في التعلم اليومي لتحقيق أقصى استفادة من التكرار المتباعد</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
        },

        /**
         * @property {object} uiManager - Manages the dynamic UI rendering for the anatomy section.
         */
        uiManager: {
            /**
             * Creates the main interface HTML for the dental anatomy section.
             * @returns {string} The HTML string for the anatomy interface.
             */
            createAnatomyInterface: function() {
                const completedLessonsCount = dentalAnatomySimulator.learningSystem.currentStudent.completedLessons.length;
                const reviewItemsCount = dentalAnatomySimulator.spacedRepetition.getTodaysReviews().length;
                const totalPoints = dentalAnatomySimulator.progressTracker.calculateTotalPoints();
                const currentMilestone = dentalAnatomySimulator.progressTracker.getCurrentMilestone(totalPoints);
                const nextMilestone = dentalAnatomySimulator.progressTracker.milestones.find(m => m.threshold > currentMilestone.threshold);
                
                let progressPercentage = 0;
                if (nextMilestone) {
                    const pointsNeededForNext = nextMilestone.threshold - currentMilestone.threshold;
                    const pointsEarnedInCurrentStage = totalPoints - currentMilestone.threshold;
                    progressPercentage = pointsNeededForNext > 0 ? Math.min(100, (pointsEarnedInCurrentStage / pointsNeededForNext) * 100) : 100;
                } else {
                    progressPercentage = 100;
                }

                return `
                    <div class="space-y-8">
                        <!-- مقدمة -->
                        <div class="text-center mb-8">
                            <h3 class="font-bold text-2xl text-gray-800 mb-4">
                                <i class="fas fa-tooth text-blue-500 mr-2"></i>
                                مركز تعلم تشريح الأسنان
                            </h3>
                            <p class="text-gray-600 max-w-3xl mx-auto">
                                تعلم تشريح الأسنان بطريقة تفاعلية تساعد على الفهم والحفظ. 
                                ابدأ بالدروس الأساسية ثم انتقل إلى التطبيقات العملية.
                            </p>
                        </div>
                        
                        <!-- خيارات التعلم -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-2xl p-6 shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer"
                                 onclick="dentalAnatomySimulator.learningSystem.startLesson('lesson-1')">
                                <div class="w-16 h-16 rounded-full dental-gradient flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-graduation-cap text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-lg text-gray-800 mb-2">ابدأ بالدروس</h4>
                                <p class="text-gray-600 text-sm">تعلم الأساسيات خطوة بخطوة</p>
                                <div class="mt-4">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">
                                        ${dentalAnatomySimulator.learningSystem.anatomyLessons.length} دروس متاحة
                                    </span>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer"
                                 onclick="dentalAnatomySimulator.toothExplorer.startExploration()">
                                <div class="w-16 h-16 rounded-full anatomy-gradient flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-search text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-lg text-gray-800 mb-2">استكشف الأسنان</h4>
                                <p class="text-gray-600 text-sm">تفاعل مع نموذج ثلاثي الأبعاد</p>
                                <div class="mt-4">
                                    <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs">
                                        ${dentalAnatomySimulator.teethDatabase.quadrants[0].teeth.length} أسنان للاستكشاف
                                    </span>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 shadow-lg text-center hover:shadow-xl transition-shadow cursor-pointer"
                                 onclick="dentalAnatomySimulator.spacedRepetition.showDailyReview()">
                                <div class="w-16 h-16 rounded-full perio-gradient flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-history text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-lg text-gray-800 mb-2">مراجعة اليوم</h4>
                                <p class="text-gray-600 text-sm">تعزيز الذاكرة طويلة المدى</p>
                                <div class="mt-4">
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs">
                                        ${reviewItemsCount} عناصر للمراجعة
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- منطقة المحتوى الديناميكي -->
                        <div id="anatomy-learning-content">
                            <!-- سيتم عرض المحتوى هنا -->
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-tooth text-4xl mb-3 text-gray-400"></i>
                                <h4 class="text-lg font-bold text-gray-700 mb-2">اختر طريقة التعلم المناسبة لك</h4>
                                <p class="text-gray-600">انقر على أحد الخيارات أعلاه لبدء رحلة التعلم</p>
                            </div>
                        </div>
                        
                        <!-- تتبع التقدم -->
                        <div class="bg-gradient-to-r from-blue-50 to-teal-50 p-6 rounded-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-lg text-gray-800">📊 تقدمك في التعلم</h4>
                                <button class="text-blue-600 hover:text-blue-700 text-sm" 
                                        onclick="dentalAnatomySimulator.progressTracker.showProgressDashboard()">
                                    <i class="fas fa-chart-line mr-1"></i> عرض التفاصيل
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>تقدم التعلم</span>
                                        <span id="current-milestone">${currentMilestone.name}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-teal-500 h-3 rounded-full transition-all duration-500" 
                                             style="width: ${progressPercentage}%">
                                            ${Math.round(progressPercentage)}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600" id="total-learning-points">${totalPoints}</div>
                                        <div class="text-xs text-gray-600">نقاط تعليمية</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-600">
                                            ${completedLessonsCount}
                                        </div>
                                        <div class="text-xs text-gray-600">دروس مكتملة</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-purple-600">
                                            ${dentalAnatomySimulator.spacedRepetition.reviewQueue.length}
                                        </div>
                                        <div class="text-xs text-gray-600">عناصر للمراجعة</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- نصائح للتعلم -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="dental-alert alert-info">
                                <h5 class="font-bold text-blue-700 mb-2">💡 نصائح للتعلم الفعال:</h5>
                                <ul class="text-sm text-blue-600 space-y-1">
                                    <li>• خذ فترات راحة كل 25-30 دقيقة</li>
                                    <li>• راجع ما تعلمته في نفس اليوم</li>
                                    <li>• استخدم التكرار المتباعد للحفظ</li>
                                    <li>• اربط المعلومات الجديدة بما تعرفه</li>
                                </ul>
                            </div>
                            
                            <div class="dental-alert alert-success">
                                <h5 class="font-bold text-green-700 mb-2">🎯 استراتيجيات الحفظ:</h5>
                                <ul class="text-sm text-green-600 space-y-1">
                                    <li>• استخدم الخرائط الذهنية</li>
                                    <li>• علم غيرك ما تعلمته</li>
                                    <li>• استخدم البطاقات التعليمية</li>
                                    <li>• مارس ما تعلمته عملياً</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        },

        /**
         * Initializes the Dental Anatomy Simulator module.
         * Sets up initial UI, progress, and review queue.
         */
        init: function() {
            const anatomyContent = document.getElementById('anatomy-content');
            if (anatomyContent) {
                // Ensure currentStudent has a currentMilestone for progress tracking
                if (!this.learningSystem.currentStudent.currentMilestone) {
                    this.learningSystem.currentStudent.currentMilestone = this.progressTracker.milestones[0].id;
                }
                anatomyContent.innerHTML = this.uiManager.createAnatomyInterface();
                
                // Record initial activity
                this.progressTracker.recordActivity('زيارة قسم التشريح', 1);
                
                // Update initial progress display
                this.progressTracker.updateProgressDisplay();

                // Add sample items to review queue for demonstration if empty
                if (this.spacedRepetition.reviewQueue.length === 0) {
                     this.spacedRepetition.addToReview(this.teethDatabase.quadrants[0].teeth[0], 'medium'); // القاطع المركزي
                     this.spacedRepetition.addToReview(this.teethDatabase.toothTissues[0], 'hard'); // المينا
                     this.spacedRepetition.addToReview(this.learningSystem.anatomyLessons[0], 'easy'); // مقدمة في تشريح الأسنان
                }

                console.log('✅ نظام تعلم تشريح الأسنان جاهز للاستخدام');
            }
        }
    };
    // END_UPDATE_DENTAL_ANATOMY_3D

    /* Imported from تحديث كلية طب الأسنان 2.txt */
    // START_UPDATE_DENTAL_ALGORITHMS
    const dentalAlgorithms = {
        
        // 1. خوارزمية تشخيص التسوس التفاعلية
        cariesDiagnosis: {
            // عوامل الخطر للتسوس
            riskFactors: [
                { id: 'sugar_freq', name: 'تكرار تناول السكريات', weight: 0.25 },
                { id: 'oral_hygiene', name: 'النظافة الفموية', weight: 0.20 },
                { id: 'fluoride', name: 'استخدام الفلورايد', weight: 0.15 },
                { id: 'saliva_flow', name: 'تدفق اللعاب', weight: 0.15 },
                { id: 'previous_caries', name: 'تاريخ التسوس السابق', weight: 0.25 }
            ],
            
            // مراحل التسوس
            cariesStages: [
                { stage: 1, name: 'بداية التسوس', description: 'بقعة بيضاء على المينا', intervention: 'الفلورايد الموضعي' },
                { stage: 2, name: 'تسوس المينا', description: 'تآكل في المينا', intervention: 'الحشو الوقائي' },
                { stage: 3, name: 'تسوس العاج', description: 'وصول التسوس للعاج', intervention: 'الحشو العادي' },
                { stage: 4, name: 'تسوس عميق', description: 'قرب اللب', intervention: 'علاج الجذور' }
            ],
            
            // بدء التشخيص التفاعلي
            startInteractiveDiagnosis: function() {
                this.createDiagnosisInterface();
            },
            
            // إنشاء واجهة التشخيص
            createDiagnosisInterface: function() {
                // Targeting the new algorithms-content div to avoid conflict with anatomy-content
                const container = document.getElementById('algorithms-content');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <!-- منطقة إدخال البيانات -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-search-plus text-blue-500 mr-2"></i>
                                    تشخيص التسوس التفاعلي
                                </h3>
                                <p class="text-gray-600 mb-6">
                                    أدخل المعلومات وسيتم حساب خطر التسوس وتشخيص المرحلة باستخدام خوارزمية طبية
                                </p>
                                
                                <div class="space-y-6" id="risk-factors-inputs">
                                    ${this.riskFactors.map(factor => `
                                        <div class="border-b pb-4">
                                            <label class="block font-medium text-gray-700 mb-2">
                                                ${factor.name}
                                                <span class="text-xs text-blue-600">(وزن: ${factor.weight * 100}%)</span>
                                            </label>
                                            <div class="mt-2 space-x-4">
                                                ${this.createRiskSlider(factor.id, factor.name)}
                                            </div>
                                            <div class="mt-2 text-sm text-gray-500" id="score-${factor.id}">
                                                درجة: 0
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-8">
                                    <button class="btn-dental w-full" onclick="dentalAlgorithms.cariesDiagnosis.calculateRisk()">
                                        <i class="fas fa-calculator mr-2"></i> حساب خطر التسوس
                                    </button>
                                </div>
                            </div>
                            
                            <!-- تفسير الخوارزمية -->
                            <div class="bg-gradient-to-br from-blue-50 to-teal-50 p-6 rounded-2xl">
                                <h4 class="font-bold text-lg text-gray-800 mb-3">
                                    <i class="fas fa-code text-gray-600 mr-2"></i>
                                    كيف تعمل الخوارزمية؟
                                </h4>
                                <div class="space-y-3 text-sm text-gray-600">
                                    <p>1. كل عامل خطر له وزن حسب أهميته العلمية</p>
                                    <p>2. يتم تحويل المدخلات إلى قيم رقمية (0-100)</p>
                                    <p>3. الخطر = Σ(الدرجة × الوزن)</p>
                                    <p>4. يتم تحديد المرحلة بناءً على النتيجة</p>
                                    <p class="mt-3 font-medium">المعادلة: خطر التسوس = ${this.riskFactors.map(f => `${f.weight} × ${f.name.split(' ')[0]}`).join(' + ')}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <!-- نتائج التشخيص -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-clipboard-check text-green-500 mr-2"></i>
                                    نتائج التشخيص
                                  </h3>
                                
                                <div id="diagnosis-results" class="space-y-6">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-stethoscope text-4xl mb-3 text-gray-400"></i>
                                        <p>أدخل المعلومات واضغط على "حساب خطر التسوس"</p>
                                    </div>
                                </div>
                                
                                <div id="risk-visualization" class="mt-6 hidden">
                                    <h4 class="font-bold text-gray-700 mb-3">📊 التمثيل البصري للخطر:</h4>
                                    <div class="relative h-8 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 rounded-full mb-2">
                                        <div id="risk-indicator" class="absolute top-0 w-6 h-10 -ml-3 border-2 border-gray-800 rounded-full bg-white"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-600">
                                        <span>منخفض</span>
                                        <span>متوسط</span>
                                        <span>مرتفع</span>
                                        <span>عالي جداً</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- مراحل التسوس -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-layer-group text-purple-500 mr-2"></i>
                                    مراحل التسوس
                                </h3>
                                
                                <div class="space-y-4">
                                    ${this.cariesStages.map(stage => `
                                        <div class="border-l-4 ${this.getStageColor(stage.stage)} pl-4 py-2">
                                            <div class="flex justify-between items-center">
                                                <h4 class="font-bold text-gray-800">${stage.name}</h4>
                                                <span class="px-2 py-1 ${this.getStageBadgeColor(stage.stage)} rounded-full text-xs">
                                                    مرحلة ${stage.stage}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">${stage.description}</p>
                                            <div class="mt-2">
                                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">
                                                    التدخل: ${stage.intervention}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                    <p class="text-sm text-yellow-700">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        الاكتشاف المبكر يمنع 80% من المضاعفات. راجع طبيب الأسنان بانتظام.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // تهيئة المنزلقات
                this.initializeSliders();
            },
            
            // إنشاء منزلق عامل خطر
            createRiskSlider: function(factorId, factorName) {
                let options = [];
                
                switch(factorId) {
                    case 'sugar_freq':
                        options = [
                            { value: 20, label: 'نادراً' },
                            { value: 40, label: 'يومياً' },
                            { value: 60, label: 'عدة مرات يومياً' },
                            { value: 80, label: 'مع كل وجبة' },
                            { value: 100, label: 'باستمرار' }
                        ];
                        break;
                        
                    case 'oral_hygiene':
                        options = [
                            { value: 100, label: 'ضعيفة' },
                            { value: 80, label: 'مقبولة' },
                            { value: 60, label: 'جيدة' },
                            { value: 40, label: 'ممتازة' },
                            { value: 20, label: 'مثالية' }
                        ];
                        break;
                        
                    case 'fluoride':
                        options = [
                            { value: 100, label: 'لا يستخدم' },
                            { value: 75, label: 'أحياناً' },
                            { value: 50, label: 'معجون فقط' },
                            { value: 25, label: 'معجون + غسول' },
                            { value: 0, label: 'بانتظام + علاجات' }
                        ];
                        break;
                        
                    case 'saliva_flow':
                        options = [
                            { value: 100, label: 'منخفض جداً' },
                            { value: 75, label: 'منخفض' },
                            { value: 50, label: 'طبيعي' },
                            { value: 25, label: 'جيد' },
                            { value: 0, label: 'ممتاز' }
                        ];
                        break;
                        
                    case 'previous_caries':
                        options = [
                            { value: 0, label: 'لا يوجد' },
                            { value: 25, label: '1-2' },
                            { value: 50, label: '3-5' },
                            { value: 75, label: '6-10' },
                            { value: 100, label: 'أكثر من 10' }
                        ];
                        break;
                }
                
                return options.map(opt => `
                    <label class="inline-flex items-center">
                        <input type="radio" name="${factorId}" value="${opt.value}" 
                               class="mr-2" 
                               onchange="dentalAlgorithms.cariesDiagnosis.updateFactorScore('${factorId}', ${opt.value})">
                        <span class="text-sm">${opt.label}</span>
                    </label>
                `).join('');
            },
            
            // تهيئة المنزلقات
            initializeSliders: function() {
                // تعيين قيم افتراضية
                this.riskFactors.forEach(factor => {
                    // Check if an input with this name exists before trying to set checked
                    const defaultOption = document.querySelector(`input[name="${factor.id}"]`);
                    if (defaultOption) {
                        defaultOption.checked = true;
                        this.updateFactorScore(factor.id, parseInt(defaultOption.value));
                    }
                });
            },
            
            // تحديث درجة عامل الخطر
            updateFactorScore: function(factorId, score) {
                const scoreElement = document.getElementById(`score-${factorId}`);
                if (scoreElement) {
                    scoreElement.textContent = `درجة: ${score}`;
                }
            },
            
            // حساب خطر التسوس
            calculateRisk: function() {
                let totalRisk = 0;
                const factorScores = [];
                
                // جمع درجات جميع العوامل
                this.riskFactors.forEach(factor => {
                    const selectedInput = document.querySelector(`input[name="${factor.id}"]:checked`);
                    if (selectedInput) {
                        const score = parseInt(selectedInput.value);
                        const weightedScore = score * factor.weight;
                        totalRisk += weightedScore;
                        
                        factorScores.push({
                            name: factor.name,
                            score: score,
                            weight: factor.weight,
                            weightedScore: weightedScore
                        });
                    }
                });
                
                // عرض النتائج
                this.displayResults(totalRisk, factorScores);
                // Record activity using the global dentalAnatomySimulator
                dentalAnatomySimulator.progressTracker.recordActivity('استخدام حاسبة التسوس', 2);
            },
            
            // عرض النتائج
            displayResults: function(totalRisk, factorScores) {
                const resultsContainer = document.getElementById('diagnosis-results');
                if (!resultsContainer) return;
                
                // تحديد مستوى الخطر
                let riskLevel, riskColor, riskDescription;
                
                if (totalRisk < 25) {
                    riskLevel = 'منخفض';
                    riskColor = 'text-green-600';
                    riskDescription = 'خطر التسوس منخفض. استمر في العادات الصحية الحالية.';
                } else if (totalRisk < 50) {
                    riskLevel = 'متوسط';
                    riskColor = 'text-yellow-600';
                    riskDescription = 'خطر تسوس متوسط. انتبه لعاداتك الغذائية والنظافة.';
                } else if (totalRisk < 75) {
                    riskLevel = 'مرتفع';
                    riskColor = 'text-orange-600';
                    riskDescription = 'خطر تسوس مرتفع. يجب اتخاذ إجراءات وقائية فورية.';
                } else {
                    riskLevel = 'عالي جداً';
                    riskColor = 'text-red-600';
                    riskDescription = 'خطر تسوس عالي جداً. راجع طبيب الأسنان فوراً.';
                }
                
                // تحديد مرحلة التسوس المقترحة
                const suggestedStage = this.suggestCariesStage(totalRisk);
                
                resultsContainer.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold ${riskColor} mb-2">${Math.round(totalRisk)}%</div>
                        <h4 class="text-lg font-bold text-gray-800 mb-1">مستوى خطر التسوس: ${riskLevel}</h4>
                        <p class="text-gray-600">${riskDescription}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-bold text-gray-700 mb-2">📊 تحليل العوامل:</h5>
                            <div class="space-y-2">
                                ${factorScores.map(factor => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">${factor.name}</span>
                                        <div class="text-right">
                                            <span class="text-sm font-medium">${factor.score} × ${factor.weight} = </span>
                                            <span class="font-bold">${factor.weightedScore.toFixed(1)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-bold text-blue-700 mb-2">💡 المرحلة المقترحة:</h5>
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full ${this.getStageColor(suggestedStage.stage).replace('border-', 'bg-')} 
                                      flex items-center justify-center text-white font-bold mr-3">
                                    ${suggestedStage.stage}
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${suggestedStage.name}</div>
                                    <div class="text-sm text-gray-600">${suggestedStage.description}</div>
                                    <div class="text-sm text-green-600 mt-1">
                                        <i class="fas fa-stethoscope mr-1"></i>
                                        ${suggestedStage.intervention}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 border rounded-lg">
                            <h5 class="font-bold text-gray-700 mb-2">🎯 التوصيات:</h5>
                            <ul class="text-sm text-gray-600 space-y-1">
                                ${this.generateRecommendations(totalRisk).map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                // عرض المؤشر البصري
                const vizContainer = document.getElementById('risk-visualization');
                if (vizContainer) {
                    vizContainer.classList.remove('hidden');
                    
                    const indicator = document.getElementById('risk-indicator');
                    if (indicator) {
                        // حساب الموضع (0-100% إلى موضع بالبكسل)
                        const position = Math.min(100, Math.max(0, totalRisk));
                        indicator.style.left = `${position}%`;
                    }
                }
                
                showDentalAlert(`تم حساب خطر التسوس: ${riskLevel} (${Math.round(totalRisk)}%)`, 'info');
            },
            
            // اقتراح مرحلة التسوس
            suggestCariesStage: function(riskScore) {
                if (riskScore < 30) return this.cariesStages[0];
                if (riskScore < 50) return this.cariesStages[1];
                if (riskScore < 70) return this.cariesStages[2];
                return this.cariesStages[3];
            },
            
            // توليد التوصيات
            generateRecommendations: function(riskScore) {
                const recommendations = [];
                
                if (riskScore > 60) {
                    recommendations.push('زيارة طبيب الأسنان خلال أسبوع');
                    recommendations.push('استخدام معجون أسنان بفلورايد عالي التركيز');
                    recommendations.push('تجنب السكريات بين الوجبات');
                } else if (riskScore > 40) {
                    recommendations.push('زيارة طبيب الأسنان خلال شهر');
                    recommendations.push('استخدام غسول فم بالفلورايد يومياً');
                    recommendations.push('تنظيف الأسنان بعد كل وجبة');
                } else {
                    recommendations.push('زيارة طبيب الأسنان كل 6 أشهر');
                    recommendations.push('مواصلة العادات الصحية الحالية');
                    recommendations.push('استخدام خيط الأسنان يومياً');
                }
                
                recommendations.push('شرب الماء بعد تناول السكريات');
                recommendations.push('مضغ علكة خالية من السكر');
                
                return recommendations;
            },
            
            // الحصول على لون المرحلة
            getStageColor: function(stage) {
                const colors = {
                    1: 'border-green-500',
                    2: 'border-yellow-500',
                    3: 'border-orange-500',
                    4: 'border-red-500'
                };
                return colors[stage] || 'border-gray-500';
            },
            
            // الحصول على لون شارة المرحلة
            getStageBadgeColor: function(stage) {
                const colors = {
                    1: 'bg-green-100 text-green-700',
                    2: 'bg-yellow-100 text-yellow-700',
                    3: 'bg-orange-100 text-orange-700',
                    4: 'bg-red-100 text-red-700'
                };
                return colors[stage] || 'bg-gray-100 text-gray-700';
            }
        },
        
        // 2. حاسبة جرعة التخدير الموضعي
        localAnesthesiaCalculator: {
            // أنواع التخدير الشائعة
            anesthetics: [
                { id: 'lidocaine', name: 'ليدوكائين', concentration: '2%', maxDoseMg: '300', maxDoseMl: '4.4' },
                { id: 'articaine', name: 'أرتيكائين', concentration: '4%', maxDoseMg: '400', maxDoseMl: '7.0' },
                { id: 'mepivacaine', name: 'مبيفاكائين', concentration: '3%', maxDoseMg: '300', maxDoseMl: '5.0' }
            ],
            
            // مواقع الحقن
            injectionSites: [
                { id: 'infiltration', name: 'تسلل بسيط', volumeMl: '0.5-1.0', description: 'للأسنان الأمامية' },
                { id: 'block', name: 'تخدير كتلي', volumeMl: '1.5-2.2', description: 'للمنطقة الخلفية' },
                { id: 'palatal', name: 'تخدير حنكي', volumeMl: '0.2-0.5', description: 'للحنك' }
            ],
            
            // بدء الحاسبة
            startCalculator: function() {
                this.createCalculatorInterface();
            },
            
            // إنشاء واجهة الحاسبة
            createCalculatorInterface: function() {
                // Targeting the new algorithms-content div
                const container = document.getElementById('algorithms-content');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <!-- إدخال البيانات -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-syringe text-blue-500 mr-2"></i>
                                    حاسبة جرعة التخدير الموضعي
                                </h3>
                                
                                <div class="space-y-6">
                                    <!-- معلومات المريض -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">👤 معلومات المريض:</h4>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    الوزن (كجم)
                                                </label>
                                                <input type="number" id="patient-weight" value="70" min="10" max="200" 
                                                       class="w-full p-3 border rounded-lg" 
                                                       onchange="dentalAlgorithms.localAnesthesiaCalculator.updateCalculations()">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    العمر (سنوات)
                                                </label>
                                                <input type="number" id="patient-age" value="30" min="1" max="120" 
                                                       class="w-full p-3 border rounded-lg"
                                                       onchange="dentalAlgorithms.localAnesthesiaCalculator.updateCalculations()">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- اختيار المخدر -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">💉 نوع المخدر:</h4>
                                        <div class="grid grid-cols-3 gap-3">
                                            ${this.anesthetics.map(anesthetic => `
                                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-blue-500">
                                                    <input type="radio" name="anesthetic" value="${anesthetic.id}" 
                                                           class="mr-3" 
                                                           onchange="dentalAlgorithms.localAnesthesiaCalculator.updateCalculations()"
                                                           ${anesthetic.id === 'lidocaine' ? 'checked' : ''}>
                                                    <div>
                                                        <div class="font-medium">${anesthetic.name}</div>
                                                        <div class="text-xs text-gray-600">${anesthetic.concentration}</div>
                                                    </div>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- اختيار موقع الحقن -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">📍 موقع الحقن:</h4>
                                        <div class="space-y-3">
                                            ${this.injectionSites.map(site => `
                                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-green-500">
                                                    <input type="radio" name="injection-site" value="${site.id}" 
                                                           class="mr-3"
                                                           onchange="dentalAlgorithms.localAnesthesiaCalculator.updateCalculations()"
                                                           ${site.id === 'infiltration' ? 'checked' : ''}>
                                                    <div class="flex-grow">
                                                        <div class="font-medium">${site.name}</div>
                                                        <div class="text-sm text-gray-600">${site.description}</div>
                                                    </div>
                                                    <div class="text-sm font-bold text-blue-600">
                                                        ${site.volumeMl} مل
                                                    </div>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- عدد الكارتردجات -->
                                    <div>
                                        <label class="block font-medium text-gray-700 mb-2">
                                            عدد الكارتردجات (1 كارتردج = 1.8 مل)
                                        </label>
                                        <div class="flex items-center space-x-4">
                                            <button class="px-4 py-2 bg-gray-200 rounded-lg" 
                                                    onclick="dentalAlgorithms.localAnesthesiaCalculator.changeCartridges(-1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" id="cartridges-count" value="1" min="0.5" max="5" step="0.5" 
                                                   class="w-32 p-3 border rounded-lg text-center font-bold"
                                                   onchange="dentalAlgorithms.localAnesthesiaCalculator.updateCalculations()">
                                            <button class="px-4 py-2 bg-gray-200 rounded-lg"
                                                    onclick="dentalAlgorithms.localAnesthesiaCalculator.changeCartridges(1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <span class="text-gray-600" id="total-volume">(1.8 مل)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- خوارزمية الحساب -->
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl">
                                <h4 class="font-bold text-lg text-gray-800 mb-3">
                                    <i class="fas fa-calculator text-purple-600 mr-2"></i>
                                    كيفية حساب الجرعة
                                </h4>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <p>1. الجرعة القصوى (ملجم) = الوزن (كجم) × الجرعة/كجم</p>
                                    <p>2. الجرعة/كجم للكبار: 4.4 ملجم/كجم للليدوكائين</p>
                                    <p>3. الجرعة المحقونة (ملجم) = التركيز (%) × 10 × الحجم (مل)</p>
                                    <p>4. نسبة الأمان = (الجرعة المحقونة ÷ الجرعة القصوى) × 100</p>
                                    <p class="mt-3 font-medium">المعادلة: %تركيز × 10 × الحجم (مل) ÷ (الوزن × 4.4) × 100</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <!-- نتائج الحساب -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                                    نتائج الحساب
                                </h3>
                                
                                <div id="anesthesia-results" class="space-y-6">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-calculator text-4xl mb-3 text-gray-400"></i>
                                        <p>أدخل المعلومات لرؤية نتائج الحساب</p>
                                    </div>
                                </div>
                                
                                <!-- تحذيرات السلامة -->
                                <div id="safety-warnings" class="mt-6 hidden">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                </div>
                                
                                <!-- تمثيل بياني -->
                                <div class="mt-8">
                                    <h4 class="font-bold text-gray-700 mb-3">📊 تمثيل الجرعة:</h4>
                                    <div class="relative h-8 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 rounded-full mb-2">
                                        <div id="dose-indicator" class="absolute top-0 w-6 h-10 -ml-3 border-2 border-gray-800 rounded-full bg-white"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-600">
                                        <span>آمنة</span>
                                        <span>متوسطة</span>
                                        <span>عالية</span>
                                        <span>خطيرة</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- معلومات إضافية -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mt-6">
                                <h4 class="font-bold text-gray-800 mb-3">💡 معلومات مهمة:</h4>
                                <div class="space-y-3 text-sm text-gray-600">
                                    <div class="flex items-start">
                                        <i class="fas fa-info-circle text-blue-500 mt-1 mr-2"></i>
                                        <p>الجرعة القصوى المطلقة للكبار: 300 ملجم للليدوكائين</p>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-2"></i>
                                        <p>تقليل الجرعة في المرضى كبار السن وذوي الأمراض المزمنة</p>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-clock text-green-500 mt-1 mr-2"></i>
                                        <p>مدة التخدير: الليدوكائين 60-90 دقيقة، الأرتيكائين 90-120 دقيقة</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // حساب أولي
                this.updateCalculations();
            },
            
            // تغيير عدد الكارتردجات
            changeCartridges: function(delta) {
                const input = document.getElementById('cartridges-count');
                if (!input) return;
                
                let value = parseFloat(input.value) || 1;
                value += delta * 0.5;
                value = Math.max(0.5, Math.min(5, value));
                
                input.value = value;
                this.updateCalculations();
            },
            
            // تحديث الحسابات
            updateCalculations: function() {
                // جمع البيانات المدخلة
                const weight = parseFloat(document.getElementById('patient-weight')?.value) || 70;
                const age = parseFloat(document.getElementById('patient-age')?.value) || 30;
                const cartridges = parseFloat(document.getElementById('cartridges-count')?.value) || 1;
                
                // المخدر المختار
                const anestheticId = document.querySelector('input[name="anesthetic"]:checked')?.value || 'lidocaine';
                const anesthetic = this.anesthetics.find(a => a.id === anestheticId);
                
                // موقع الحقن المختار
                const siteId = document.querySelector('input[name="injection-site"]:checked')?.value || 'infiltration';
                const site = this.injectionSites.find(s => s.id === siteId);
                
                if (!anesthetic || !site) { // Defensive check
                    console.error("Anesthetic or site not found.");
                    return;
                }

                // الحسابات
                const volumeMl = cartridges * 1.8; // كل كارتردج 1.8 مل
                const concentrationPercent = parseFloat(anesthetic.concentration);
                const doseMg = concentrationPercent * 10 * volumeMl; // تركيز % × 10 × الحجم مل
                
                // الجرعة القصوى بناءً على الوزن
                const maxDosePerKg = 4.4; // ملجم/كجم للكبار
                const maxDoseBasedOnWeight = weight * maxDosePerKg;
                
                // الجرعة القصوى المطلقة
                const absoluteMaxDose = parseFloat(anesthetic.maxDoseMg);
                
                // نسبة الأمان
                const safetyPercentage = (doseMg / Math.min(maxDoseBasedOnWeight, absoluteMaxDose)) * 100;
                
                // تحديث الحجم الكلي
                const volumeElement = document.getElementById('total-volume');
                if (volumeElement) {
                    volumeElement.textContent = `(${volumeMl.toFixed(1)} مل)`;
                }
                
                // عرض النتائج
                this.displayResults({
                    weight,
                    age,
                    anesthetic,
                    site,
                    volumeMl,
                    doseMg,
                    maxDoseBasedOnWeight,
                    absoluteMaxDose,
                    safetyPercentage
                });
            },
            
            // عرض النتائج
            displayResults: function(data) {
                const resultsContainer = document.getElementById('anesthesia-results');
                if (!resultsContainer) return;
                
                // تحديد مستوى الأمان
                let safetyLevel, safetyColor, safetyIcon;
                
                if (data.safetyPercentage < 50) {
                    safetyLevel = 'آمنة جداً';
                    safetyColor = 'text-green-600';
                    safetyIcon = 'fa-check-circle';
                } else if (data.safetyPercentage < 80) {
                    safetyLevel = 'آمنة';
                    safetyColor = 'text-yellow-600';
                    safetyIcon = 'fa-exclamation-circle';
                } else if (data.safetyPercentage < 100) {
                    safetyLevel = 'متوسطة الخطورة';
                    safetyColor = 'text-orange-600';
                    safetyIcon = 'fa-exclamation-triangle';
                } else {
                    safetyLevel = 'خطيرة - تجاوز الحد الآمن';
                    safetyColor = 'text-red-600';
                    safetyIcon = 'fa-times-circle';
                }
                
                resultsContainer.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold ${safetyColor} mb-2">${data.safetyPercentage.toFixed(1)}%</div>
                        <h4 class="text-lg font-bold text-gray-800 mb-1">نسبة استخدام الجرعة القصوى</h4>
                        <p class="${safetyColor} font-medium">
                            <i class="fas ${safetyIcon} mr-2"></i>
                            مستوى الأمان: ${safetyLevel}
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded text-center">
                                <div class="text-sm text-gray-500">الجرعة المحقونة</div>
                                <div class="text-xl font-bold text-blue-600">${data.doseMg.toFixed(1)} ملجم</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded text-center">
                                <div class="text-sm text-gray-500">الجرعة القصوى المسموحة</div>
                                <div class="text-xl font-bold text-green-600">${Math.min(data.maxDoseBasedOnWeight, data.absoluteMaxDose).toFixed(1)} ملجم</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-bold text-blue-700 mb-2">📝 تفاصيل الحساب:</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                     <span class="text-gray-600">المخدر:</span>
                                    <span class="font-medium">${data.anesthetic.name} ${data.anesthetic.concentration}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">الحجم المحقون:</span>
                                    <span class="font-medium">${data.volumeMl.toFixed(1)} مل (${(data.volumeMl/1.8).toFixed(1)} كارتردج)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">موقع الحقن:</span>
                                    <span class="font-medium">${data.site.name}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">الوزن:</span>
                                    <span class="font-medium">${data.weight} كجم</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 border rounded-lg">
                            <h5 class="font-bold text-gray-700 mb-2">🧮 خطوات الحساب:</h5>
                            <ol class="text-sm text-gray-600 space-y-2 list-decimal list-inside">
                                <li>التركيز: ${data.anesthetic.concentration} = ${parseFloat(data.anesthetic.concentration) * 10} ملجم/مل</li>
                                <li>الجرعة = ${parseFloat(data.anesthetic.concentration) * 10} × ${data.volumeMl.toFixed(1)} = ${data.doseMg.toFixed(1)} ملجم</li>
                                <li>الجرعة/كجم = ${data.weight} × 4.4 = ${data.maxDoseBasedOnWeight.toFixed(1)} ملجم</li>
                                <li>النسبة = (${data.doseMg.toFixed(1)} ÷ ${Math.min(data.maxDoseBasedOnWeight, data.absoluteMaxDose).toFixed(1)}) × 100 = ${data.safetyPercentage.toFixed(1)}%</li>
                            </ol>
                        </div>
                    </div>
                `;
                
                // تحديث المؤشر البصري
                const indicator = document.getElementById('dose-indicator');
                if (indicator) {
                    const position = Math.min(100, Math.max(0, data.safetyPercentage));
                    indicator.style.left = `${position}%`;
                }
                
                // عرض تحذيرات السلامة
                this.displaySafetyWarnings(data);
                
                // تسجيل النشاط
                dentalAnatomySimulator.progressTracker.recordActivity('استخدام حاسبة التخدير', 2);
            },
            
            // عرض تحذيرات السلامة
            displaySafetyWarnings: function(data) {
                const warningsContainer = document.getElementById('safety-warnings');
                if (!warningsContainer) return;
                
                warningsContainer.classList.remove('hidden');
                
                let warnings = [];
                
                if (data.safetyPercentage > 100) {
                    warnings.push({
                        type: 'danger',
                        message: '⚠️ <strong>خطر:</strong> تجاوزت الجرعة الحد الأقصى المسموح به! قلل عدد الكارتردجات.'
                    });
                }
                
                if (data.safetyPercentage > 80 && data.safetyPercentage <= 100) {
                    warnings.push({
                        type: 'warning',
                        message: '⚠️ <strong>تحذير:</strong> الجرعة قريبة من الحد الأقصى. كن حذراً.'
                    });
                }
                
                if (data.age > 65) {
                    warnings.push({
                        type: 'info',
                        message: 'ℹ️ <strong>ملاحظة:</strong> للمرضى كبار السن، فكر في تقليل الجرعة بنسبة 20-30%.'
                    });
                }
                
                if (data.weight < 50) {
                    warnings.push({
                        type: 'warning',
                        message: '⚠️ <strong>تحذير:</strong> الوزن منخفض. الجرعة/كجم مرتفعة نسبياً.'
                    });
                }
                
                // إذا كانت الجرعة آمنة
                if (data.safetyPercentage < 50) {
                    warnings.push({
                        type: 'success',
                        message: '✅ <strong>آمنة:</strong> الجرعة ضمن النطاق الآمن تماماً.'
                    });
                }
                
                // عرض التحذيرات
                warningsContainer.innerHTML = `
                    <h4 class="font-bold text-gray-700 mb-3">⚠️ تنبيهات السلامة:</h4>
                    <div class="space-y-2">
                        ${warnings.map(warning => `
                            <div class="p-3 rounded-lg ${warning.type === 'danger' ? 'bg-red-50 border border-red-200 text-red-700' :
                                                            warning.type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700' :
                                                            warning.type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
                                                            'bg-blue-50 border border-blue-200 text-blue-700'}">
                                ${warning.message}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        },
        
        // 3. حاسبة إعدادات الأشعة السينية
        xraySettingsCalculator: {
            // أنواع أفلام الأشعة
            filmTypes: [
                { id: 'f-speed', name: 'سرعة F', exposureReduction: '25%', detail: 'عالي' },
                { id: 'd-speed', name: 'سرعة D', exposureReduction: '0%', detail: 'متوسط' },
                { id: 'digital', name: 'رقمي', exposureReduction: '50%', detail: 'عالي جداً' }
            ],
            
            // مناطق الفم
            mouthRegions: [
                { id: 'anterior', name: 'أمامي', kvp: '60-70', ma: '7-10', seconds: '0.2-0.5' },
                { id: 'posterior', name: 'خلفي', kvp: '65-75', ma: '10-15', seconds: '0.3-0.6' },
                { id: 'bitewing', name: 'عضة', kvp: '65-70', ma: '10', seconds: '0.4' },
                { id: 'panoramic', name: 'بانورامي', kvp: '70-85', ma: '10-15', seconds: '15-20' }
            ],
            
            // بدء الحاسبة
            startCalculator: function() {
                this.createCalculatorInterface();
            },
            
            // إنشاء واجهة الحاسبة
            createCalculatorInterface: function() {
                // Targeting the new algorithms-content div
                const container = document.getElementById('algorithms-content');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <!-- إدخال البيانات -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-x-ray text-blue-500 mr-2"></i>
                                    حاسبة إعدادات الأشعة السنية
                                </h3>
                                
                                <div class="space-y-6">
                                    <!-- معلومات المريض -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">👤 معلومات المريض:</h4>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    العمر (سنوات)
                                                </label>
                                                <input type="number" id="patient-age-xray" value="30" min="1" max="120" 
                                                       class="w-full p-3 border rounded-lg"
                                                       onchange="dentalAlgorithms.xraySettingsCalculator.calculateSettings()">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    حالة الفم
                                                </label>
                                                <select id="oral-condition" class="w-full p-3 border rounded-lg"
                                                        onchange="dentalAlgorithms.xraySettingsCalculator.calculateSettings()">
                                                    <option value="normal">طبيعي</option>
                                                    <option value="edentulous">فاقد الأسنان</option>
                                                    <option value="restored">معظم الأسنان معالجة</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- اختيار نوع الفيلم -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">🎞️ نوع الفيلم/المستشعر:</h4>
                                        <div class="grid grid-cols-3 gap-3">
                                            ${this.filmTypes.map(film => `
                                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-blue-500">
                                                    <input type="radio" name="film-type" value="${film.id}" 
                                                           class="mr-3" 
                                                           onchange="dentalAlgorithms.xraySettingsCalculator.calculateSettings()"
                                                           ${film.id === 'digital' ? 'checked' : ''}>
                                                    <div>
                                                        <div class="font-medium">${film.name}</div>
                                                        <div class="text-xs text-gray-600">تقليل التعرض: ${film.exposureReduction}</div>
                                                    </div>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- اختيار المنطقة -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">📍 المنطقة المصورة:</h4>
                                        <div class="grid grid-cols-2 gap-3">
                                            ${this.mouthRegions.map(region => `
                                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:border-green-500">
                                                    <input type="radio" name="mouth-region" value="${region.id}" 
                                                           class="mr-3"
                                                           onchange="dentalAlgorithms.xraySettingsCalculator.calculateSettings()"
                                                           ${region.id === 'anterior' ? 'checked' : ''}>
                                                    <div class="flex-grow">
                                                        <div class="font-medium">${region.name}</div>
                                                        <div class="text-xs text-gray-600">${region.kvp} كيلوفولت</div>
                                                    </div>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- ضبط المعلمات -->
                                    <div>
                                        <h4 class="font-bold text-gray-700 mb-3">⚙️ ضبط المعلمات:</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    الجهد (كيلوفولت)
                                                </label>
                                                <input type="range" id="kvp-slider" min="50" max="90" value="70" 
                                                       class="w-full"
                                                       oninput="dentalAlgorithms.xraySettingsCalculator.updateKvpValue(this.value)">
                                                <div class="flex justify-between text-xs text-gray-600">
                                                    <span>50</span>
                                                    <span id="kvp-value">70 كيلوفولت</span>
                                                    <span>90</span>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    شدة التيار (ملي أمبير)
                                                </label>
                                                <input type="range" id="ma-slider" min="5" max="20" value="10" 
                                                       class="w-full"
                                                       oninput="dentalAlgorithms.xraySettingsCalculator.updateMaValue(this.value)">
                                                <div class="flex justify-between text-xs text-gray-600">
                                                    <span>5</span>
                                                    <span id="ma-value">10 ملي أمبير</span>
                                                    <span>20</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- خوارزمية الحساب -->
                            <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-6 rounded-2xl">
                                <h4 class="font-bold text-lg text-gray-800 mb-3">
                                    <i class="fas fa-calculator text-gray-600 mr-2"></i>
                                    مبدأ ALARA في الأشعة
                                </h4>
                                <div class="space-y-3 text-sm text-gray-600">
                                    <p><strong>ALARA:</strong> As Low As Reasonably Achievable</p>
                                    <p>1. استخدم أعلى كيلوفولت ممكن مع أقل ملي أمبير</p>
                                    <p>2. استخدم الفيلم الرقمي لتقليل الجرعة 50-80%</p>
                                    <p>3. استخدم الحجاب الرصاصي وحامي الغدة الدرقية</p>
                                    <p>4. قلل زمن التعرض لأقل ما يمكن</p>
                                    <p class="mt-3 font-medium">المعادلة: الجرعة ∝ (ملي أمبير × الزمن) ÷ (كيلوفولت)²</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <!-- نتائج الإعدادات -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg">
                                <h3 class="font-bold text-xl text-gray-800 mb-4">
                                    <i class="fas fa-sliders-h text-green-500 mr-2"></i>
                                    الإعدادات المقترحة
                                </h3>
                                
                                <div id="xray-results" class="space-y-6">
                                    <!-- سيتم ملؤها ديناميكياً -->
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-x-ray text-4xl mb-3 text-gray-400"></i>
                                        <p>أدخل المعلومات لرؤية الإعدادات المقترحة</p>
                                    </div>
                                </div>
                                
                                <!-- جرعة الإشعاع -->
                                <div id="radiation-dose" class="mt-6 hidden">
                                    <h4 class="font-bold text-gray-700 mb-3">📊 جرعة الإشعاع المقدرة:</h4>
                                    <div class="relative h-8 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 rounded-full mb-2">
                                        <div id="dose-indicator-xray" class="absolute top-0 w-6 h-10 -ml-3 border-2 border-gray-800 rounded-full bg-white"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-600">
                                        <span>منخفضة جداً</span>
                                        <span>منخفضة</span>
                                        <span>متوسطة</span>
                                        <span>عالية</span>
                                    </div>
                                </div>
                                
                                <!-- جدول المقارنة -->
                                <div class="mt-8 bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-bold text-gray-700 mb-3">📋 مقارنة بين الأنواع:</h4>
                                    <div class="overflow-x-auto">
                                        <table class="dental-table w-full text-sm">
                                            <thead>
                                                <tr>
                                                    <th>النوع</th>
                                                    <th>تقليل الجرعة</th>
                                                    <th>التفاصيل</th>
                                                    <th>الاستخدام</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${this.filmTypes.map(film => `
                                                    <tr>
                                                        <td class="font-medium">${film.name}</td>
                                                        <td>${film.exposureReduction}</td>
                                                        <td>${film.detail}</td>
                                                        <td>${film.id === 'digital' ? 'الأفضل' : 'تقليدي'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- نصائح السلامة -->
                            <div class="bg-white rounded-2xl p-6 shadow-lg mt-6">
                                <h4 class="font-bold text-gray-800 mb-3">⚠️ نصائح السلامة:</h4>
                                <div class="space-y-3 text-sm text-gray-600">
                                    <div class="flex items-start">
                                        <i class="fas fa-shield-alt text-blue-500 mt-1 mr-2"></i>
                                        <p>استخدم الدرع الواقي لكل مريض دون استثناء</p>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-user-md text-green-500 mt-1 mr-2"></i>
                                        <p>اخرج من الغرفة أثناء التعرض للأشعة</p>
                                    </div>
                                    <div class="flex items-start">
                                        <i class="fas fa-baby text-yellow-500 mt-1 mr-2"></i>
                                        <p>تجنب الأشعة للحوامل إلا للضرورة القصوى</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // حساب أولي
                this.calculateSettings();
            },
            
            // تحديث قيمة كيلوفولت
            updateKvpValue: function(value) {
                document.getElementById('kvp-value').textContent = `${value} كيلوفولت`;
                this.calculateSettings();
            },
            
            // تحديث قيمة ملي أمبير
            updateMaValue: function(value) {
                document.getElementById('ma-value').textContent = `${value} ملي أمبير`;
                this.calculateSettings();
            },
            
            // حساب الإعدادات
            calculateSettings: function() {
                // جمع البيانات المدخلة
                const age = parseInt(document.getElementById('patient-age-xray')?.value) || 30;
                const oralCondition = document.getElementById('oral-condition')?.value;
                const filmTypeId = document.querySelector('input[name="film-type"]:checked')?.value || 'digital';
                const regionId = document.querySelector('input[name="mouth-region"]:checked')?.value || 'anterior';
                
                // قيم المنزلقات
                const kvp = parseInt(document.getElementById('kvp-slider')?.value) || 70;
                const ma = parseInt(document.getElementById('ma-slider')?.value) || 10;
                
                // البحث عن البيانات
                const film = this.filmTypes.find(f => f.id === filmTypeId);
                const region = this.mouthRegions.find(r => r.id === regionId);

                if (!film || !region || !oralCondition) { // Defensive check
                    console.error("Film, region, or oral condition not found.");
                    return;
                }
                
                // حساب زمن التعرض المقترح
                let seconds = this.calculateExposureTime(region, film, age, oralCondition);
                
                // حساب جرعة الإشعاع النسبية
                const relativeDose = this.calculateRelativeDose(kvp, ma, seconds, film);
                
                // عرض النتائج
                this.displayResults({
                    age,
                    oralCondition,
                    film,
                    region,
                    kvp,
                    ma,
                    seconds,
                    relativeDose
                });
            },
            
            // حساب زمن التعرض
            calculateExposureTime: function(region, film, age, oralCondition) {
                // القيم الأساسية حسب المنطقة
                let baseSeconds = parseFloat(region.seconds.split('-')[0]);
                
                // تعديل حسب العمر
                if (age < 12) baseSeconds *= 0.7; // تقليل للأطفال
                if (age > 65) baseSeconds *= 0.8; // تقليل لكبار السن
                
                // تعديل حسب حالة الفم
                if (oralCondition === 'edentulous') baseSeconds *= 0.6;
                if (oralCondition === 'restored') baseSeconds *= 1.2;
                
                // تعديل حسب نوع الفيلم
                if (film.id === 'digital') baseSeconds *= 0.5;
                if (film.id === 'f-speed') baseSeconds *= 0.75;
                
                return Math.max(0.1, Math.min(2.0, baseSeconds)).toFixed(2);
            },
            
            // حساب الجرعة النسبية
            calculateRelativeDose: function(kvp, ma, seconds, film) {
                // الجرعة تتناسب مع (ملي أمبير × الزمن) وتتناسب عكسياً مع مربع كيلوفولت
                let dose = (ma * parseFloat(seconds)) / (kvp * kvp) * 100;
                
                // تقليل حسب نوع الفيلم
                if (film.id === 'digital') dose *= 0.5;
                if (film.id === 'f-speed') dose *= 0.75;
                
                return Math.min(100, Math.max(0, dose));
            },
            
            // عرض النتائج
            displayResults: function(data) {
                const resultsContainer = document.getElementById('xray-results');
                if (!resultsContainer) return;
                
                // تحديد مستوى الجرعة
                let doseLevel, doseColor;
                
                if (data.relativeDose < 25) {
                    doseLevel = 'منخفضة جداً';
                    doseColor = 'text-green-600';
                } else if (data.relativeDose < 50) {
                    doseLevel = 'منخفضة';
                    doseColor = 'text-blue-600';
                } else if (data.relativeDose < 75) {
                    doseLevel = 'متوسطة';
                    doseColor = 'text-yellow-600';
                } else {
                    doseLevel = 'عالية';
                    doseColor = 'text-red-600';
                }
                
                resultsContainer.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold ${doseColor} mb-2">${data.relativeDose.toFixed(1)}%</div>
                        <h4 class="text-lg font-bold text-gray-800 mb-1">الجرعة النسبية</h4>
                        <p class="${doseColor} font-medium">مستوى الجرعة: ${doseLevel}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-bold text-blue-700 mb-2">⚙️ الإعدادات المقترحة:</h5>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-sm text-gray-500">الجهد</div>
                                    <div class="text-xl font-bold text-blue-600">${data.kvp} كيلوفولت</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">شدة التيار</div>
                                    <div class="text-xl font-bold text-blue-600">${data.ma} ملي أمبير</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">زمن التعرض</div>
                                    <div class="text-xl font-bold text-blue-600">${data.seconds} ثانية</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 border rounded-lg">
                            <h5 class="font-bold text-gray-700 mb-2">📊 تفاصيل الحساب:</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">المنطقة:</span>
                                    <span class="font-medium">${data.region.name}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">نوع الفيلم:</span>
                                    <span class="font-medium">${data.film.name} (تقليل ${data.film.exposureReduction})</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">العمر:</span>
                                    <span class="font-medium">${data.age} سنة</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">حالة الفم:</span>
                                    <span class="font-medium">${data.oralCondition === 'normal' ? 'طبيعي' : data.oralCondition === 'edentulous' ? 'فاقد الأسنان' : 'معظم الأسنان معالجة'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
                            <h5 class="font-bold text-yellow-700 mb-2">💡 توصيات:</h5>
                            <ul class="text-sm text-yellow-600 space-y-1">
                                ${this.generateXrayRecommendations(data).map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                // عرض مؤشر الجرعة
                const doseContainer = document.getElementById('radiation-dose');
                if (doseContainer) {
                    doseContainer.classList.remove('hidden');
                    
                    const indicator = document.getElementById('dose-indicator-xray');
                    if (indicator) {
                        indicator.style.left = `${data.relativeDose}%`;
                    }
                }
                
                // تسجيل النشاط
                dentalAnatomySimulator.progressTracker.recordActivity('استخدام حاسبة الأشعة', 2);
            },
            
            // توليد توصيات الأشعة
            generateXrayRecommendations: function(data) {
                const recommendations = [];
                
                if (data.relativeDose > 70) {
                    recommendations.push('جرعة عالية نسبياً. فكر في تقليل زمن التعرض');
                    recommendations.push('تحقق من أن جهاز الأشعة معاير بشكل صحيح');
                }
                
                if (data.film.id !== 'digital') {
                    recommendations.push('فكر في الانتقال للتصوير الرقمي لتقليل الجرعة 50%');
                }
                
                if (data.age < 18) {
                    recommendations.push('للأطفال، استخدم إعدادات خاصة بالأطفال');
                    recommendations.push('قلل منطقة التعرض قدر الإمكان');
                }
                
                recommendations.push('استخدم حامي الغدة الدرقية دائماً');
                recommendations.push('اخرج من الغرفة أثناء التقاط الصورة');
                
                return recommendations;
            }
        },
        
        // 4. واجهة النظام الرئيسية
        uiManager: {
            createAlgorithmsInterface: function() {
                return `
                    <div class="space-y-8">
                        <!-- مقدمة -->
                        <div class="text-center mb-8">
                            <h3 class="font-bold text-2xl text-gray-800 mb-4">
                                <i class="fas fa-calculator text-blue-500 mr-2"></i>
                                أدوات الحساب والخوارزميات الطبية
                            </h3>
                            <p class="text-gray-600 max-w-3xl mx-auto">
                                استخدم هذه الأدوات التفاعلية لفهم كيفية عمل الحسابات الطبية في طب الأسنان.
                                أدخل البيانات وشاهد كيف تعالجها الخوارزميات لإنتاج نتائج سريرية.
                            </p>
                        </div>
                        
                        <!-- اختيار الأداة -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                            <h4 class="font-bold text-lg text-gray-800 mb-6">
                                <i class="fas fa-tools text-blue-600 mr-2"></i>
                                اختر أداة للحساب:
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="border rounded-xl p-5 hover:shadow-lg transition-shadow duration-300 cursor-pointer card-algo"
                                     onclick="dentalAlgorithms.cariesDiagnosis.startInteractiveDiagnosis()">
                                    <div class="flex items-center mb-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-pink-500 
                                              flex items-center justify-center text-white text-xl mr-3">
                                            <i class="fas fa-search-plus"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-bold text-gray-800">تشخيص التسوس</h5>
                                            <p class="text-xs text-gray-600">خوارزمية تقييم الخطر</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        احسب خطر التسوس بناءً على عوامل الخطر باستخدام خوارزمية موزونة.
                                    </p>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">
                                            5 عوامل خطر
                                        </span>
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                            خوارزمية موزونة
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="border rounded-xl p-5 hover:shadow-lg transition-shadow duration-300 cursor-pointer card-algo"
                                     onclick="dentalAlgorithms.localAnesthesiaCalculator.startCalculator()">
                                    <div class="flex items-center mb-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-teal-500 
                                              flex items-center justify-center text-white text-xl mr-3">
                                            <i class="fas fa-syringe"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-bold text-gray-800">جرعة التخدير</h5>
                                            <p class="text-xs text-gray-600">حاسبة الجرعات الآمنة</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        احسب الجرعة الآمنة للتخدير الموضعي بناءً على وزن المريض ونوع المخدر.
                                    </p>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                            3 أنواع مخدر
                                        </span>
                                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                                            حساب الجرعة/كجم
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="border rounded-xl p-5 hover:shadow-lg transition-shadow duration-300 cursor-pointer card-algo"
                                     onclick="dentalAlgorithms.xraySettingsCalculator.startCalculator()">
                                    <div class="flex items-center mb-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-600 to-gray-800 
                                              flex items-center justify-center text-white text-xl mr-3">
                                            <i class="fas fa-x-ray"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-bold text-gray-800">إعدادات الأشعة</h5>
                                            <p class="text-xs text-gray-600">مبدأ ALARA</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">
                                        احسب إعدادات الأشعة المثلى مع تقليل الجرعة الإشعاعية للمريض.
                                    </p>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                                            4 مناطق
                                        </span>
                                        <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">
                                            تقليل الجرعة
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- منطقة المحتوى التفاعلي -->
                        <div id="algorithms-content-interactive">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-calculator text-4xl mb-3 text-gray-400"></i>
                                <h4 class="text-lg font-bold text-gray-700 mb-2">اختر أداة حسابية لبدء الاستخدام</h4>
                                <p class="text-gray-600">انقر على أحد الخيارات أعلاه لفتح الأداة التفاعلية</p>
                            </div>
                        </div>
                        
                        <!-- تفسير الخوارزميات -->
                        <div class="bg-gradient-to-r from-blue-50 to-teal-50 p-6 rounded-2xl">
                            <h4 class="font-bold text-lg text-gray-800 mb-4">
                                <i class="fas fa-code-branch text-purple-600 mr-2"></i>
                                كيف تساعدك الخوارزميات على التعلم؟
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5 class="font-bold text-gray-700 mb-2">🧠 الفهم العميق:</h5>
                                    <ul class="text-sm text-gray-600 space-y-2">
                                        <li>• ترى كيف تتحول البيانات المدخلة إلى نتائج سريرية</li>
                                        <li>• تفهم أهمية كل عامل في المعادلة الطبية</li>
                                        <li>• تتعلم كيفية ترجيح العوامل المختلفة</li>
                                        <li>• ترى العلاقة بين المتغيرات والنتائج</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold text-gray-700 mb-2">🎯 التطبيق العملي:</h5>
                                    <ul class="text-sm text-gray-600 space-y-2">
                                        <li>• تطبق المعرفة النظرية على حالات افتراضية</li>
                                        <li>• تتعلم اتخاذ قرارات سريرية مستنيرة</li>
                                        <li>• تفهم حدود وأخطاء الحسابات الطبية</li>
                                        <li>• تتدرب على تفسير النتائج وتقديم التوصيات</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        },
        
        // 5. التهيئة
        init: function() {
            const algorithmsContent = document.getElementById('algorithms-content');
            if (algorithmsContent) {
                // Ensure the main algorithms interface is loaded into the #algorithms-content div
                algorithmsContent.innerHTML = this.uiManager.createAlgorithmsInterface();
                
                // When an individual calculator is chosen, its content will be injected into a sub-div
                // within the algorithms-content. The individual calculator functions (e.g., cariesDiagnosis.createDiagnosisInterface)
                // expect to write to `algorithms-content` (after my modifications).
                // Initial content for the interactive sub-area
                const interactiveArea = document.getElementById('algorithms-content-interactive');
                if (interactiveArea) {
                    interactiveArea.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <i class="fas fa-calculator text-4xl mb-3 text-gray-400"></i>
                            <h4 class="text-lg font-bold text-gray-700 mb-2">اختر أداة حسابية لبدء الاستخدام</h4>
                            <p class="text-gray-600">انقر على أحد الخيارات أعلاه لفتح الأداة التفاعلية</p>
                        </div>
                    `;
                }

                // Register initial activity for progress tracking
                dentalAnatomySimulator.progressTracker.recordActivity('زيارة قسم الخوارزميات', 1);
                
                console.log('✅ أدوات الخوارزميات الطبية جاهزة للاستخدام');
            }
        }
    };
    // END_UPDATE_DENTAL_ALGORITHMS

    // وظائف التنقل الأساسية
    function openDentalTool(toolName) {
        // إخفاء كل المحتويات
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // إزالة النشاط من جميع الأزرار
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('bg-blue-600', 'text-white');
            button.classList.add('bg-gray-100', 'text-gray-700');
        });
        
        // إظهار المحتوى المطلوب
        const content = document.getElementById(toolName + '-content');
        if (content) {
            content.classList.add('active');
            
            // NEW: Initialize dentalAnatomySimulator when 'anatomy' tab is opened
            // This ensures the interactive content loads dynamically for the anatomy section.
            if (toolName === 'anatomy') {
                dentalAnatomySimulator.init();
            }
            // NEW: Initialize dentalAlgorithms when 'algorithms' tab is opened
            else if (toolName === 'algorithms') {
                dentalAlgorithms.init();
            }
        }
        
        // تفعيل الزر المحدد
        const button = document.querySelector(`[data-tab="${toolName}"]`);
        if (button) {
            button.classList.remove('bg-gray-100', 'text-gray-700');
            button.classList.add('bg-blue-600', 'text-white');
        }
        
        // تحديث نشاط بطاقة الأداة
        document.querySelectorAll('.tool-card').forEach(card => {
            card.classList.remove('active');
        });
        
        const toolCard = document.querySelector(`[data-tool="${toolName}"]`);
        if (toolCard) {
            toolCard.classList.add('active');
        }
        
        showDentalAlert(`تم فتح ${getToolName(toolName)}`, 'success');
    }
    
    function getToolName(toolId) {
        const toolNames = {
            'anatomy': 'تشريح الأسنان',
            'endodontics': 'علاج الجذور',
            'prosthodontics': 'البدائل السنية',
            'periodontics': 'أمراض اللثة',
            'oral-surgery': 'جراحة الفم',
            'radiology': 'أشعة الفم',
            'pedodontics': 'طب أسنان الأطفال',
            'quizzes': 'الاختبارات',
            'algorithms': 'الخوارزميات والحسابات' /* Added for the new module */
        };
        return toolNames[toolId] || toolId;
    }
    
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function showDentalAlert(message, type = 'info') {
        // إنشاء عنصر التنبيه
        const alertDiv = document.createElement('div');
        alertDiv.className = `dental-alert alert-${type} fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50`;
        alertDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'} 
                       text-${type === 'success' ? 'green' : type === 'warning' ? 'yellow' : type === 'danger' ? 'red' : 'blue'}-600 mr-3"></i>
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        // إزالة التنبيه بعد 5 ثوانٍ
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // تهيئة الأحداث
    document.addEventListener('DOMContentLoaded', function() {
        // أحداث أزرار التبويب
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                openDentalTool(tabId);
            });
        });
        
        // أحداث بطاقات الأدوات
        document.querySelectorAll('.tool-card').forEach(card => {
            card.addEventListener('click', function() {
                const toolId = this.getAttribute('data-tool');
                openDentalTool(toolId);
            });
        });
        
        // NEW: Automatically open 'anatomy' tab and initialize simulator on page load
        // This leverages the existing 'anatomy-content' being active by default in the base HTML.
        openDentalTool('anatomy');
        
        console.log('✅ أداة كلية طب الأسنان التعليمية جاهزة للاستخدام');
    });
    </script>
</body>
</html>
